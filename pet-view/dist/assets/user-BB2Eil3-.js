import{u as U,h as P,j as E,I as b,v as L,E as u,ag as T}from"./index-CdkwbEeW.js";import{s as S}from"./request-AZOEAvTT.js";import{d as g}from"./dog-DzFJ_7DI.js";const m=g,R=100*1024*1024,_=["jpg","jpeg","png","gif","webp","bmp"],W=/^1[3-9]\d{9}$/,j=5e3,x=async()=>{try{return localStorage.getItem("jwt_token")?{success:!0,data:(await S.get("/user/profile")).data,message:"获取用户资料成功"}:{success:!1,data:null,message:"用户未登录或缺少必要信息"}}catch(s){return s.response&&(s.response.status===401||s.response.status===403)?{success:!1,data:null,message:"用户未登录或缺少必要信息"}:{success:!1,data:null,message:"获取用户资料失败"}}},J=()=>{const{t:s}=U(),d=M(),c=P(),f=P(!1),r=E({userName:"",email:"",phone:"",headPic:"",introduce:""}),a=P(null),p=b(()=>({username:[{required:!0,message:s("user.usernameRequired"),trigger:"blur"},{min:3,max:20,message:s("user.usernameLength"),trigger:"blur"}],email:[{required:!0,message:s("user.emailRequired"),trigger:"blur"},{type:"email",message:s("user.emailInvalid"),trigger:"blur"}],phone:[{pattern:W,message:s("user.phoneInvalid"),trigger:"blur"}],bio:[{max:200,message:s("user.bioMax"),trigger:"blur"}]})),l=t=>{const o=t.name.split(".").pop()?.toLowerCase()||"",i=_.includes(o),h=t.size<R;return i?h?!0:(u.error(s("message.avatarSizeError")),!1):(u.error(s("message.avatarFormatError")),!1)},v=async t=>{const o=t.file;if(!l(o))return;a.value=o;const i=new FileReader;i.onload=h=>{r.headPic=h.target?.result},i.onerror=()=>{u.error(s("avatarPreviewFailed")),r.headPic=m},i.readAsDataURL(o)},y=()=>{r.headPic&&r.headPic!==m&&(r.headPic=m)},N=t=>new Promise(o=>{const i=new Image;i.onload=()=>{o(!0)},i.onerror=()=>{o(!1)},i.src=t,setTimeout(()=>{o(!1)},j)}),A=async t=>{try{return t.startsWith("http")||t.startsWith("https")||t.startsWith("data:image")?t:t?`/images/${t}`:m}catch{return m}},I=async(t,o=!1)=>{r.userName=t.userName||"",r.email=t.email||"",r.phone=t.phone||"",r.introduce=t.introduce||"",o&&t.headPic?r.headPic=await A(t.headPic):r.headPic=t.headPic||m},e=async()=>{try{await d.fetchProfile(),await I(d.info,!0)}catch{u.error(s("message.getUserInfoFailed")),r.headPic=m}},n=async()=>{c.value&&await c.value.validate(async t=>{if(t){f.value=!0;try{const o=new FormData;a.value&&o.append("avatar",a.value),r.userName&&o.append("userName",r.userName),r.phone&&o.append("phone",r.phone),r.introduce&&o.append("introduce",r.introduce),r.email&&o.append("email",r.email);const i=await S.put("/user/profile",o);if(i&&i.code===200){const h={userName:r.userName,email:r.email,phone:r.phone,introduce:r.introduce};i?.data?.headPic?h.headPic=i.data.headPic:h.headPic=m,d.setUserProfile(h),u.success(s("user.profileUpdated")),a.value=null}else throw new Error(i?.message||s("user.updateFailed"))}catch(o){u.error(o.message||o.response?.data?.message||s("user.updateFailed"))}finally{f.value=!1}}})};async function F(){await I(d.info),u.success(s("user.formReset"))}return L(()=>{e()}),{t:s,profileFormRef:c,loading:f,profileForm:r,pendingAvatarFile:a,computedRules:p,beforeImageUpload:l,handleImageUpload:v,handleImageError:y,testImageLoad:N,loadUserProfile:e,submitForm:n,resetForm:F}},w=g,M=T("user",()=>{const d=(e=>{if(!e)return null;try{const n=JSON.parse(e);return n.headPic&&n.headPic.startsWith("data:image")&&(n.headPic=w),n}catch{return null}})(localStorage.getItem("userInfo")),c=localStorage.getItem("userId"),f=localStorage.getItem("userName");let r;if(d)try{r=d,!r.userId&&c&&(r.userId=parseInt(c))}catch{localStorage.removeItem("userInfo"),r={userName:"",headPic:g,userId:c?parseInt(c):0,email:"",phone:"",introduce:""}}else r={userName:f||"",headPic:g,userId:c?parseInt(c):0,email:"",phone:"",introduce:""};const a=E(r);let p=!1,l=null;return{info:a,fetchProfile:async()=>(p&&l||(p=!0,l=(async()=>{try{const e=await x();if(e.success){typeof e.data=="object"&&e.data!==null?(a.userName="",a.headPic=g,a.email="",a.phone="",a.introduce="",a.userName=e.data.userName||"",a.headPic=e.data.headPic||g,a.email=e.data.email||"",a.phone=e.data.phone||"",a.introduce=e.data.introduce||"",e.data.userId&&(a.userId=e.data.userId)):typeof e.data=="number"&&(a.userId=e.data);const n={...a,headPic:a.headPic.startsWith("data:image")?w:a.headPic};localStorage.setItem("userInfo",JSON.stringify(n))}else e.message!=="用户未登录或缺少必要信息"&&u.error(e.message||"获取用户资料失败")}catch{u.error("获取用户资料失败")}finally{p=!1,l=null}})()),l),changePassword:async e=>{try{const n=await S.put("/user/updatePassword",{currentPassword:e.currentPassword,newPassword:e.newPassword});if(n.code===200)return{success:!0,message:"密码修改成功"};throw new Error(n?.message||"密码修改失败")}catch(n){throw n}},setUserProfile:e=>{e.userName&&(a.userName=e.userName,localStorage.setItem("userName",a.userName)),e.headPic&&(e.headPic.startsWith("data:image")?a.headPic=e.headPic:(a.headPic=e.headPic,localStorage.setItem("headPic",a.headPic))),e.email!==void 0&&(a.email=e.email,localStorage.setItem("email",a.email)),e.phone!==void 0&&(a.phone=e.phone,localStorage.setItem("phone",e.phone)),e.introduce!==void 0&&(a.introduce=e.introduce,localStorage.setItem("introduce",e.introduce));const n={...a,headPic:a.headPic.startsWith("data:image")?w:a.headPic};localStorage.setItem("userInfo",JSON.stringify(n))},setUsername:e=>{a.userName=e,localStorage.setItem("userName",e)},resetUser:()=>{a.userId=0,a.userName="",a.headPic=g,a.email="",a.phone="",a.introduce="",localStorage.removeItem("userInfo"),localStorage.removeItem("userName"),localStorage.removeItem("headPic"),localStorage.removeItem("email"),localStorage.removeItem("phone"),localStorage.removeItem("introduce"),localStorage.removeItem("jwt_token")}}});export{J as a,M as u};
