import{u as ae,i as A,k as oe,O as T,E as p,s as E,P as ie,_ as ne,a0 as re,l as ce,h as de,D as he,a1 as ue,c as d,o as h,a as t,H as K,t as a,p as s,v as f,a2 as N,Y as W,F as V,f as $,g,n as y,q as le,x as j}from"./index-vX8o4tFx.js";import{useThemeStore as pe}from"./theme-BuSJrrmb.js";const me=()=>{const{t:r}=ae(),o=A([]),m=A([]),P=A(!1),H=A(""),k=A(""),b=A(""),M=A("list"),v=A(!1),D=A(!1),n=oe({healthId:"",pid:"",healthType:"",checkDate:"",description:"",reminderTime:"",status:"normal"}),u=()=>{if(m.value.length===0){p.warning(r("noAssociatedPetPleaseAdoptOrFoster"));return}v.value=!0},B=T(()=>o.value.length),x=T(()=>o.value.filter(e=>e.status==="normal")),R=T(()=>o.value.filter(e=>e.status==="critical")),U=T(()=>x.value),F=T(()=>R.value),q=T(()=>R.value),S=T(()=>{let e=o.value;return H.value&&(e=e.filter(l=>l.pid===Number(H.value))),k.value&&(e=e.filter(l=>l.healthType===k.value)),b.value&&(e=e.filter(l=>l.status===b.value)),e.sort((l,c)=>new Date(c.checkDate).getTime()-new Date(l.checkDate).getTime())}),z=T(()=>{const e={};return S.value.forEach(l=>{const c=new Date(l.checkDate).toDateString();e[c]||(e[c]=[]),e[c].push(l)}),e}),w=async()=>{P.value=!0;try{const e=await E.get("/user/health-alerts");console.log("å¥åº·è­¦æŠ¥APIåŽŸå§‹å“åº”:",e),console.log("å¥åº·è­¦æŠ¥APIå“åº”æ•°æ®:",JSON.stringify(e,null,2)),await C();const l=m.value.map(c=>c.pid);if(console.log("ç”¨æˆ·æ‹¥æœ‰çš„å® ç‰©IDåˆ—è¡¨:",l),e&&e.data&&e.data.alerts&&Array.isArray(e.data.alerts)){const c=e.data.alerts;o.value=c.filter(i=>{const te=Number(i.pid),se=l.includes(te);return console.log(`è¿‡æ»¤æ£€æŸ¥ - alertPid: ${te}, ç”¨æˆ·å® ç‰©: ${se}`),se}).map(i=>(console.log("å¥åº·æé†’alertæ•°æ®:",i),{healthId:i.healthId,pid:Number(i.pid),checkDate:i.checkDate,healthType:i.healthType,description:i.description,reminderTime:i.reminderTime,status:i.status,createdAt:i.createdAt,updatedAt:i.updatedAt,hid:i.healthId,alertType:i.healthType,time:i.checkDate,content:i.description}))}console.log("è¿‡æ»¤åŽçš„å¥åº·è­¦æŠ¥æ•°æ®:",o.value)}catch{p.error(r("api.getPetListFailed")),o.value=[]}finally{P.value=!1}},C=async()=>{try{let e;try{e=await E.get("/user/adoptions",{params:{current_page:1,per_page:100}})}catch(c){p.error(r("api.getAdoptionRecordsFailed")+": "+(c.message||r("unknownError"))),e={success:!1,data:{adoptions:[]}}}e||(e={success:!1,data:{adoptions:[]}});const l=[];if(console.log("é¢†å…»è®°å½•APIå“åº”:",e),e.code===200){const c=e.data.records;console.log("å¤„ç†é¢†å…»è®°å½•æ•°æ®:",c),c.forEach(i=>{i.pid&&l.push({pid:Number(i.pid),name:i.name,species:i.species||"",breed:i.breed})})}console.log("æå–çš„å® ç‰©åˆ—è¡¨:",l),m.value=l}catch(e){console.error(r("api.getPetListFailed"),e),p.error(r("api.getPetListFailed")),m.value=[]}};return{healthAlerts:o,pets:m,loading:P,selectedPet:H,selectedHealthType:k,selectedStatus:b,viewMode:M,showAddModal:v,showEditModal:D,formData:n,totalAlerts:B,normalAlerts:x,criticalAlerts:R,pendingAlerts:U,completedAlerts:F,expiredAlerts:q,filteredAlerts:S,groupedAlerts:z,showAddModalDialog:u,updateAlertStatus:async(e,l)=>{try{await E.put(`/user/health-alerts/${e}/status?status=${l}`),await w(),p.success(r("api.updateSuccess"))}catch{p.error(r("api.updateFailed"))}},deleteAlert:async e=>{try{if(!e||e===""||e==="undefined"){p.error("é”™è¯¯ï¼šæ— æ•ˆçš„è®°å½•IDï¼Œæ— æ³•è¿›è¡Œåˆ é™¤"),console.error("åˆ é™¤å¤±è´¥ï¼ŒæŽ¥æ”¶åˆ°ä¸€ä¸ªæ— æ•ˆçš„ID:",e,"ç±»åž‹:",typeof e);return}const l=Number(e);if(isNaN(l)||l<=0){p.error("é”™è¯¯ï¼šä¸æ˜¯æœ‰æ•ˆçš„æ•´æ•°ID"),console.error("åˆ é™¤å¤±è´¥ï¼Œè½¬æ¢åˆ°ä¸æœ‰æ•ˆæ•´æ•°:",e);return}await ie.confirm(r("api.confirmDeleteHealthAlert"),r("api.deleteConfirmation"),{confirmButtonText:r("api.confirm"),cancelButtonText:r("api.cancel"),type:"warning"}),await E.delete(`/user/health-alerts/${l}`),await w(),p.success(r("api.deleteSuccess"))}catch(l){l!=="cancel"&&(p.error(r("api.deleteFailed")),console.error("åˆ é™¤å¥åº·æé†’å¤±è´¥:",l))}},saveAlert:async()=>{try{if(!n.pid){p.error(r("api.pleaseSelectPet"));return}let e=n.checkDate;n.checkDate&&n.checkDate.includes("T")&&(e=n.checkDate.replace("T"," "));let l=n.reminderTime;n.reminderTime&&n.reminderTime.includes("T")&&(l=n.reminderTime.replace("T"," "));const c={pid:n.pid,healthType:n.healthType,checkDate:e,reminderTime:l||null,status:n.status,description:n.description};console.log("ä¿å­˜å¥åº·æé†’æ‰§æ•ˆæ•°æ®ï¼š",{åŽŸå§‹è¡¨å•æ•°æ®:n,æ ¼å¼åŒ–åŽæ•°æ®:c,æ˜¯æ›´æ–°:!!n.healthId});let i;n.healthId?i=await E.put(`/user/health-alerts/${n.healthId}`,c):i=await E.post("/user/health-alerts",c),i.data?(p.success(n.healthId?r("api.updateHealthAlertSuccess"):r("api.createHealthAlertSuccess")),v.value=!1,D.value=!1,await w()):p.error(r("api.operationFailed"))}catch(e){console.error(r("api.saveHealthAlertFailed"),e),p.error(r("api.saveHealthAlertFailed"))}},closeModal:()=>{v.value=!1,D.value=!1,n.healthId="",n.pid="",n.healthType="",n.checkDate="",n.reminderTime="",n.status="normal",n.description=""},initializeHealthAlerts:async()=>{console.log("å¼€å§‹åˆå§‹åŒ–å¥åº·æé†’æ•°æ®"),await C(),console.log("å® ç‰©æ•°æ®åŠ è½½å®Œæˆ:",m.value),m.value.length>0?(await w(),console.log("å¥åº·æé†’æ•°æ®åŠ è½½å®Œæˆ:",o.value)):(console.log("æ²¡æœ‰å® ç‰©æ•°æ®ï¼Œä¸åŠ è½½å¥åº·æé†’"),o.value=[]),console.log("initializeHealthAlerts: åˆå§‹åŒ–å®Œæˆï¼Œå® ç‰©æ•°é‡:",m.value.length,"å¥åº·æé†’æ•°é‡:",o.value.length)},getStatusClass:e=>{const l=e==="normal"?"normal":e==="critical"?"critical":e;return{pending:l==="normal",completed:l==="normal",expired:l==="critical",normal:l==="normal",critical:l==="critical"}},getHealthTypeLabel:e=>e?{VACCINE:r("healthAlerts.vaccine"),CHECKUP:r("healthAlerts.checkup"),SURGERY:r("healthAlerts.surgery"),DISEASE:r("healthAlerts.disease")}[e]||e:r("healthAlerts.noType","æœªåˆ†ç±»"),getStatusLabel:e=>e?{normal:r("healthAlerts.normal"),critical:r("healthAlerts.critical"),pending:r("healthAlerts.pending"),completed:r("healthAlerts.completed"),expired:r("healthAlerts.expired")}[e]||e:r("healthAlerts.unknown","æœªçŸ¥"),formatDate:e=>{if(!e)return"æœªè®¾ç½®";try{const l=new Date(e);return isNaN(l.getTime())?e:l.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}},editAlert:e=>{n.healthId=e.healthId||e.hid||"",n.pid=Number(e.pid)||"",n.healthType=e.healthType||e.alertType||"",n.checkDate=(e.checkDate||e.time||"").replace(" ","T"),n.reminderTime=(e.reminderTime||"").replace(" ","T"),n.status=e.status||"normal",n.description=e.description||e.content||"",console.log("ç¼–è¾‘æé†’æ•°æ®:",{healthId:n.healthId,pid:n.pid,healthType:n.healthType,checkDate:n.checkDate,reminderTime:n.reminderTime,status:n.status,description:n.description}),D.value=!0},getPetName:e=>{console.log(`getPetNameè¢«è°ƒç”¨ï¼Œå‚æ•°pid: ${e} (ç±»åž‹: ${typeof e})`),console.log("å½“å‰å® ç‰©åˆ—è¡¨:",m.value);const l=m.value.find(i=>(console.log(`æ¯”è¾ƒ: p.pid=${i.pid} (ç±»åž‹: ${typeof i.pid}) === pid=${e} (ç±»åž‹: ${typeof e})`,i.pid===e),i.pid===e)),c=l?l.name:"æœªçŸ¥å® ç‰©";return console.log(`getPetNameè¿”å›žç»“æžœ: ${c}`),c}}},ve={class:"page-header"},Ae={class:"stats-grid"},fe={class:"stat-card total"},ge={class:"stat-content"},ye={class:"stat-card normal"},_e={class:"stat-content"},Te={class:"stat-card critical"},ke={class:"stat-content"},be={class:"controls-section"},De={class:"filter-group"},Se={value:""},we=["value"],Ce={value:""},Ie={value:"VACCINE"},Pe={value:"CHECKUP"},He={value:"SURGERY"},Ee={value:"DISEASE"},Ne={value:""},Me={value:"normal"},Re={value:"critical"},Ue={class:"alerts-section"},Le={class:"section-header"},Ve={class:"view-toggle"},$e={key:0,class:"alerts-list"},xe={class:"alert-header"},Fe={class:"pet-info"},qe={key:1,class:"health-type unclassified"},ze={class:"alert-content"},Be={class:"description"},Oe={class:"alert-meta"},Ye={class:"check-date"},Ge={key:0,class:"reminder-time"},Ke={class:"alert-actions"},We=["onClick"],je=["onClick"],Je={key:1,class:"empty-state"},Qe={key:2,class:"timeline-view"},Xe={class:"timeline"},Ze={class:"timeline-date"},et={class:"timeline-items"},tt={class:"timeline-content"},st={class:"timeline-header"},lt={key:1,class:"health-type unclassified"},at={class:"description"},ot={class:"timeline-status"},it={key:0,class:"timeline-reminder"},nt={key:3,class:"empty-state"},rt={class:"modal-header"},ct={class:"form-group"},dt={value:""},ht=["value"],ut={class:"form-group"},pt={value:""},mt={value:"VACCINE"},vt={value:"CHECKUP"},At={value:"SURGERY"},ft={value:"DISEASE"},gt={class:"form-group"},yt={class:"form-group"},_t={value:"normal"},Tt={value:"critical"},kt={class:"form-group"},bt=["placeholder"],Dt={class:"form-group"},St={class:"form-help"},wt={class:"modal-actions"},Ct={type:"submit",class:"save-btn"},It={__name:"Health",setup(r){const{t:o}=ae(),m=pe(),{healthAlerts:P,pets:H,selectedPet:k,selectedHealthType:b,selectedStatus:M,viewMode:v,showAddModal:D,showEditModal:n,formData:u,totalAlerts:B,normalAlerts:x,criticalAlerts:R,filteredAlerts:U,groupedAlerts:F,getPetName:q,getHealthTypeLabel:S,getStatusLabel:z,getStatusClass:w,formatDate:C,editAlert:J,deleteAlert:Q,saveAlert:O,closeModal:_,initializeHealthAlerts:X}=me(),{createWebSocketConnection:Z,closeWebSocketConnection:ee,syncHealthAlertsToStorage:Y,checkAndSendReminders:G}=re();let L=null;return ce(async()=>{await X(),Y(P.value);const I=de();I.info.userId&&Z(I.info.userId),console.log("å¯åŠ¨å®šæ—¶æé†’æ£€æŸ¥ï¼ˆæ¯60ç§’ï¼‰"),L=setInterval(()=>{console.log("æ‰§è¡Œå®šæ—¶æé†’æ£€æŸ¥..."),G()},6e4),G()}),he(P,I=>{console.log("å¥åº·æé†’æ•°æ®å˜åŒ–ï¼ŒåŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ–°æ•°é‡:",I.length),Y(I)},{deep:!0}),ue(()=>{L&&(clearInterval(L),L=null),ee()}),(I,e)=>(h(),d("div",{class:y(["health-alerts-container",{"dark-theme":s(m).preferences.theme==="dark"}])},[t("div",ve,[t("h1",null,a(s(o)("healthAlerts.pageTitle")),1),t("p",null,a(s(o)("healthAlerts.description")),1)]),t("div",Ae,[t("div",fe,[e[17]||(e[17]=t("div",{class:"stat-icon"},"ðŸ“„",-1)),t("div",ge,[t("h3",null,a(s(B)),1),t("p",null,a(s(o)("healthAlerts.totalRecords")),1)])]),t("div",ye,[e[18]||(e[18]=t("div",{class:"stat-icon"},"âœ…",-1)),t("div",_e,[t("h3",null,a(s(x).length),1),t("p",null,a(s(o)("healthAlerts.normalStatus")),1)])]),t("div",Te,[e[19]||(e[19]=t("div",{class:"stat-icon"},"âš ï¸",-1)),t("div",ke,[t("h3",null,a(s(R).length),1),t("p",null,a(s(o)("healthAlerts.criticalStatus")),1)])])]),t("div",be,[t("div",De,[f(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>W(k)?k.value=l:null),class:"filter-select"},[t("option",Se,a(s(o)("healthAlerts.allPets")),1),(h(!0),d(V,null,$(s(H),l=>(h(),d("option",{key:l.pid,value:l.pid},a(l.name),9,we))),128))],512),[[N,s(k)]]),f(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>W(b)?b.value=l:null),class:"filter-select"},[t("option",Ce,a(s(o)("healthAlerts.allTypes")),1),t("option",Ie,a(s(o)("healthAlerts.vaccine")),1),t("option",Pe,a(s(o)("healthAlerts.checkup")),1),t("option",He,a(s(o)("healthAlerts.surgery")),1),t("option",Ee,a(s(o)("healthAlerts.disease")),1)],512),[[N,s(b)]]),f(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>W(M)?M.value=l:null),class:"filter-select"},[t("option",Ne,a(s(o)("healthAlerts.allStatus")),1),t("option",Me,a(s(o)("healthAlerts.normal")),1),t("option",Re,a(s(o)("healthAlerts.critical")),1)],512),[[N,s(M)]])]),t("button",{class:"add-button",onClick:e[3]||(e[3]=()=>{s(_)(),D.value=!0})},[e[20]||(e[20]=t("span",null,"+",-1)),g(" "+a(s(o)("healthAlerts.addHealthRecord")),1)])]),t("div",Ue,[t("div",Le,[t("h2",null,a(s(o)("healthAlerts.title")),1),t("div",Ve,[t("button",{class:y({active:s(v)==="list"}),onClick:e[4]||(e[4]=l=>v.value="list")},a(s(o)("healthAlerts.listView")),3),t("button",{class:y({active:s(v)==="timeline"}),onClick:e[5]||(e[5]=l=>v.value="timeline")},a(s(o)("healthAlerts.timelineView")),3)])]),s(v)==="list"&&s(U).length>0?(h(),d("div",$e,[(h(!0),d(V,null,$(s(U),l=>(h(),d("div",{key:l.healthId||l.hid,class:y(["alert-card",s(w)(l.status)])},[t("div",xe,[t("div",Fe,[t("h4",null,a(s(q)(l.pid)),1),l.healthType||l.alertType?(h(),d("span",{key:0,class:y(["health-type",(l.healthType||l.alertType||"").toLowerCase()])},a(s(S)(l.healthType||l.alertType)),3)):(h(),d("span",qe,a(s(S)(null)),1))]),t("div",{class:y(["alert-status",(l.status||"").toLowerCase()])},a(s(z)(l.status)),3)]),t("div",ze,[t("p",Be,a(l.description||"(æœªå¡«å†™)"),1),t("div",Oe,[t("span",Ye,[t("strong",null,a(s(o)("healthAlerts.checkTime"))+":",1),g(" "+a(s(C)(l.checkDate)),1)]),l.reminderTime?(h(),d("span",Ge,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),g(" "+a(s(C)(l.reminderTime)),1)])):K("",!0)])]),t("div",Ke,[t("button",{class:"action-btn edit-btn",onClick:c=>s(J)(l)},a(s(o)("healthAlerts.editRecord")),9,We),t("button",{class:"action-btn delete-btn",onClick:c=>s(Q)(l.healthId||l.hid)},a(s(o)("healthAlerts.deleteRecord")),9,je)])],2))),128))])):s(v)==="list"&&s(U).length===0?(h(),d("div",Je,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)])):s(v)==="timeline"&&Object.keys(s(F)).length>0?(h(),d("div",Qe,[t("div",Xe,[(h(!0),d(V,null,$(s(F),(l,c)=>(h(),d("div",{key:c,class:"timeline-group"},[t("div",Ze,a(s(C)(c)),1),t("div",et,[(h(!0),d(V,null,$(l,i=>(h(),d("div",{key:i.healthId||i.hid,class:y(["timeline-item",s(w)(i.status)])},[e[21]||(e[21]=t("div",{class:"timeline-marker"},null,-1)),t("div",tt,[t("div",st,[t("h4",null,a(s(q)(i.pid)),1),i.healthType||i.alertType?(h(),d("span",{key:0,class:y(["health-type",(i.healthType||i.alertType||"").toLowerCase()])},a(s(S)(i.healthType||i.alertType)),3)):(h(),d("span",lt,a(s(S)(null)),1))]),t("p",at,a(i.description||"(æœªå¡«å†™)"),1),t("div",ot,[t("span",{class:y((i.status||"").toLowerCase())},a(s(z)(i.status)),3)]),i.reminderTime?(h(),d("div",it,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),g(" "+a(s(C)(i.reminderTime)),1)])):K("",!0)])],2))),128))])]))),128))])])):(h(),d("div",nt,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)]))]),s(D)||s(n)?(h(),d("div",{key:0,class:"modal-overlay",onClick:e[16]||(e[16]=(...l)=>s(_)&&s(_)(...l))},[t("div",{class:"modal-content",onClick:e[15]||(e[15]=le(()=>{},["stop"]))},[t("div",rt,[t("h3",null,a(s(n)?s(o)("healthAlerts.editHealthRecord"):s(o)("healthAlerts.addHealthRecord")),1),t("button",{class:"close-btn",onClick:e[6]||(e[6]=(...l)=>s(_)&&s(_)(...l))},"Ã—")]),t("form",{onSubmit:e[14]||(e[14]=le((...l)=>s(O)&&s(O)(...l),["prevent"])),class:"modal-form"},[t("div",ct,[t("label",null,[g(a(s(o)("healthAlerts.petName")),1),e[22]||(e[22]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>s(u).pid=l),required:"",class:"form-select"},[t("option",dt,a(s(o)("healthAlerts.selectPet")),1),(h(!0),d(V,null,$(s(H),l=>(h(),d("option",{key:l.pid,value:l.pid},a(l.name),9,ht))),128))],512),[[N,s(u).pid]])]),t("div",ut,[t("label",null,[g(a(s(o)("healthAlerts.healthType")),1),e[23]||(e[23]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[8]||(e[8]=l=>s(u).healthType=l),required:"",class:"form-select"},[t("option",pt,a(s(o)("healthAlerts.selectType")),1),t("option",mt,a(s(o)("healthAlerts.vaccine")),1),t("option",vt,a(s(o)("healthAlerts.checkup")),1),t("option",At,a(s(o)("healthAlerts.surgery")),1),t("option",ft,a(s(o)("healthAlerts.disease")),1)],512),[[N,s(u).healthType]])]),t("div",gt,[t("label",null,[g(a(s(o)("healthAlerts.checkTime")),1),e[24]||(e[24]=t("span",{class:"required"},"*",-1))]),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[9]||(e[9]=l=>s(u).checkDate=l),required:"",class:"form-input"},null,512),[[j,s(u).checkDate]])]),t("div",yt,[t("label",null,[g(a(s(o)("healthAlerts.healthStatus")),1),e[25]||(e[25]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[10]||(e[10]=l=>s(u).status=l),required:"",class:"form-select"},[t("option",_t,a(s(o)("healthAlerts.normal")),1),t("option",Tt,a(s(o)("healthAlerts.critical")),1)],512),[[N,s(u).status]])]),t("div",kt,[t("label",null,[g(a(s(o)("healthAlerts.descriptionLabel")),1),e[26]||(e[26]=t("span",{class:"required"},"*",-1))]),f(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=l=>s(u).description=l),placeholder:s(o)("healthAlerts.descriptionPlaceholder"),class:"form-textarea",rows:"3"},null,8,bt),[[j,s(u).description]])]),t("div",Dt,[t("label",null,a(s(o)("healthAlerts.reminderTime")),1),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[12]||(e[12]=l=>s(u).reminderTime=l),class:"form-input"},null,512),[[j,s(u).reminderTime]]),t("small",St,a(s(o)("healthAlerts.ifNotSet")),1)]),t("div",wt,[t("button",{type:"button",class:"cancel-btn",onClick:e[13]||(e[13]=(...l)=>s(_)&&s(_)(...l))},a(s(o)("healthAlerts.cancel")),1),t("button",Ct,a(s(n)?s(o)("healthAlerts.update"):s(o)("healthAlerts.save")),1)])],32)])])):K("",!0)],2))}},Et=ne(It,[["__scopeId","data-v-365c1674"]]);export{Et as default};
