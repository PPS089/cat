import{u as F,h as w,j as A,I as b,v as L,E as i,ah as _}from"./index-BrRsyrLM.js";import{s as S}from"./request-DVyWtN3q.js";import{d as p}from"./dog-DzFJ_7DI.js";const I=p,v="/api/images/",R=2*1024*1024,T=["jpg","jpeg","png","gif","webp","bmp"],$=/^1[3-9]\d{9}$/,O=5e3,x=1e3,y=async()=>{try{const r=localStorage.getItem("userId");return!localStorage.getItem("jwt_token")||!r?(console.warn("用户未登录或缺少必要信息"),{success:!1,data:null,message:"用户未登录或缺少必要信息"}):{success:!0,data:(await S.get("/user/profile")).data,message:"获取用户资料成功"}}catch(r){return r.response&&(r.response.status===401||r.response.status===403)?{success:!1,data:null,message:"用户未登录或缺少必要信息"}:{success:!1,data:null,message:"获取用户资料失败"}}},D=()=>{const{t:r}=F(),o=M(),m=w(),c=w(!1),e=A({userName:"",email:"",phone:"",headPic:"",introduce:""}),u=w(null),d=b(()=>({username:[{required:!0,message:r("user.usernameRequired"),trigger:"blur"},{min:3,max:20,message:r("user.usernameLength"),trigger:"blur"}],email:[{required:!0,message:r("user.emailRequired"),trigger:"blur"},{type:"email",message:r("user.emailInvalid"),trigger:"blur"}],phone:[{pattern:$,message:r("user.phoneInvalid"),trigger:"blur"}],bio:[{max:200,message:r("user.bioMax"),trigger:"blur"}]})),P=t=>{const a=t.name.split(".").pop()?.toLowerCase()||"",n=T.includes(a),l=t.size<R;return n?l?!0:(i.error(r("message.avatarSizeError")),!1):(i.error(r("message.avatarFormatError")),!1)},U=async t=>{const a=t.file;if(!P(a))return;u.value=a;const n=new FileReader;n.onload=l=>{e.headPic=l.target?.result},n.onerror=()=>{i.error(r("avatarPreviewFailed")),e.headPic=I},n.readAsDataURL(a)},N=t=>new Promise(a=>{const n=new Image;n.onload=()=>{console.log("头像测试加载成功:",t),a(!0)},n.onerror=()=>{console.log("头像测试加载失败:",t),a(!1)},n.src=t,setTimeout(()=>{console.log("头像测试加载超时:",t),a(!1)},O)}),h=(t,a=!1)=>{e.userName=t.userName||"",e.email=t.email||"",e.phone=t.phone||"",e.introduce=t.introduce||"",a&&t.headPic?e.headPic=`${v}${t.headPic}`:e.headPic=t.headPic||I},s=async()=>{try{if(o.info&&o.info.userId&&o.info.userId!==0)h(o.info);else{const t=await y();if(t.success&&t.data){const a=t.data;h(a,!0),o.setUserProfile({userName:a.userName,headPic:a.headPic?`${v}${a.headPic}`:I,email:a.email,phone:a.phone,introduce:a.introduce})}else i.error("获取用户资料失败")}}catch{i.error(r("message.getUserInfoFailed"))}},f=async()=>{m.value&&await m.value.validate(async t=>{if(t){c.value=!0;try{const a=new FormData;u.value&&a.append("avatar",u.value),e.userName&&a.append("userName",e.userName),e.phone&&a.append("phone",e.phone),e.introduce&&a.append("introduce",e.introduce),e.email&&a.append("email",e.email);const n=await S.put("/user/profile",a);if(n.code===200){const l={userName:e.userName,email:e.email,phone:e.phone,introduce:e.introduce};let g;n.data?.headPic?g=`${v}${n.data.headPic}`:u.value&&(g=e.headPic||void 0),g?.trim()?setTimeout(async()=>{await N(g)?(l.headPic=g,o.setUserProfile(l),i.success(r("user.profileUpdated"))):(l.headPic=o.info.headPic||I,o.setUserProfile(l),i.warning("头像更新可能存在延迟，如长时间未显示请刷新页面")),u.value=null},x):(o.setUserProfile(l),i.success(r("user.profileUpdated")))}else i.error(n.message||r("user.updateFailed"))}catch(a){i.error(a.response?.data?.message||r("user.updateFailed"))}finally{c.value=!1}}})};function E(){h(o.info),i.success(r("user.formReset"))}return L(()=>{s()}),{t:r,profileFormRef:m,loading:c,profileForm:e,pendingAvatarFile:u,computedRules:d,beforeImageUpload:P,handleImageUpload:U,testImageLoad:N,loadUserProfile:s,submitForm:f,resetForm:E}},M=_("user",()=>{const r=localStorage.getItem("userInfo"),o=localStorage.getItem("userId"),m=localStorage.getItem("userName");let c;if(r)try{c=JSON.parse(r),!c.userId&&o&&(c.userId=parseInt(o))}catch{localStorage.removeItem("userInfo"),c={userName:"",headPic:p,userId:o?parseInt(o):0,email:"",phone:"",introduce:""}}else c={userName:m||"",headPic:p,userId:o?parseInt(o):0,email:"",phone:"",introduce:""};const e=A(c);let u=!1,d=null;return{info:e,fetchProfile:async()=>u&&d?d:e.userId&&e.userId!==0&&e.userName&&e.userName!==""?Promise.resolve():(u=!0,d=(async()=>{try{const s=await y();s.success?(typeof s.data=="object"&&s.data!==null?(e.userName="",e.headPic=p,e.email="",e.phone="",e.introduce="",e.userName=s.data.userName||"",e.headPic=s.data.headPic?`/api/images/${s.data.headPic}`:p,e.email=s.data.email||"",e.phone=s.data.phone||"",e.introduce=s.data.introduce||"",s.data.userId&&(e.userId=s.data.userId)):typeof s.data=="number"&&(e.userId=s.data),localStorage.setItem("userInfo",JSON.stringify(e))):s.message!=="用户未登录或缺少必要信息"&&i.error(s.message||"获取用户资料失败")}catch{i.error("获取用户资料失败")}finally{u=!1,d=null}})(),d),changePassword:async s=>{try{const f=await S.put("/user/updatePassword",{currentPassword:s.currentPassword,newPassword:s.newPassword});if(f.code===200)return{success:!0,message:"密码修改成功"};throw new Error(f?.message||"密码修改失败")}catch(f){throw f}},setUserProfile:s=>{s.userName&&(e.userName=s.userName,localStorage.setItem("userName",e.userName)),s.headPic&&(e.headPic=s.headPic,localStorage.setItem("headPic",e.headPic)),s.email!==void 0&&(e.email=s.email,localStorage.setItem("email",s.email)),s.phone!==void 0&&(e.phone=s.phone,localStorage.setItem("phone",s.phone)),s.introduce!==void 0&&(e.introduce=s.introduce,localStorage.setItem("introduce",s.introduce)),localStorage.setItem("userInfo",JSON.stringify(e))},setUsername:s=>{e.userName=s,localStorage.setItem("userName",s)}}});export{D as a,M as u};
