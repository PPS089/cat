import{u as ae,h as A,j as oe,M as T,E as m,N as ie,_ as ne,Z as re,k as ce,B as de,$ as he,c as d,o as h,a as t,D as Y,t as a,m as s,q as f,a0 as P,W as j,F as V,f as x,g as _,n as g,p as le,v as O}from"./index-CzjmnDZ-.js";import{s as M}from"./request-Dybetxu6.js";import{u as ue}from"./user-BSv0veCE.js";import{useThemeStore as pe}from"./theme-BvsCIQ48.js";const me=()=>{const{t:r}=ae(),o=A([]),v=A([]),E=A(!1),H=A(""),k=A(""),b=A(""),N=A("list"),p=A(!1),S=A(!1),n=oe({healthId:0,pid:0,healthType:"",checkDate:"",description:"",reminderTime:"",status:"normal"}),u=()=>{if(v.value.length===0){m.warning(r("noAssociatedPetPleaseAdoptOrFoster"));return}p.value=!0},B=T(()=>o.value.length),F=T(()=>o.value.filter(e=>e.status==="normal")),R=T(()=>o.value.filter(e=>e.status==="critical")),U=T(()=>F.value),$=T(()=>R.value),q=T(()=>R.value),w=T(()=>{let e=o.value;return H.value&&(e=e.filter(l=>l.pid===Number(H.value))),k.value&&(e=e.filter(l=>l.healthType===k.value)),b.value&&(e=e.filter(l=>l.status===b.value)),e.sort((l,c)=>new Date(c.checkDate).getTime()-new Date(l.checkDate).getTime())}),z=T(()=>{const e={};return w.value.forEach(l=>{const c=new Date(l.checkDate).toDateString();e[c]||(e[c]=[]),e[c].push(l)}),e}),C=async()=>{E.value=!0;try{const e=await M.get("/user/health-alerts");await D();const l=v.value.map(c=>c.pid);if(console.log("ç”¨æˆ·æ‹¥æœ‰çš„å® ç‰©IDåˆ—è¡¨:",l),e&&e.data&&e.data.alerts&&Array.isArray(e.data.alerts)){const c=e.data.alerts;o.value=c.filter(i=>{const te=Number(i.pid),se=l.includes(te);return console.log(`è¿‡æ»¤æ£€æŸ¥ - alertPid: ${te}, ç”¨æˆ·å® ç‰©: ${se}`),se}).map(i=>(console.log("å¥åº·æé†’alertæ•°æ®:",i),{healthId:i.healthId,pid:Number(i.pid),checkDate:i.checkDate,healthType:i.healthType,description:i.description,reminderTime:i.reminderTime,status:i.status,createdAt:i.createdAt,updatedAt:i.updatedAt}))}console.log("è¿‡æ»¤åŽçš„å¥åº·è­¦æŠ¥æ•°æ®:",o.value)}catch{m.error(r("api.getPetListFailed")),o.value=[]}finally{E.value=!1}},D=async()=>{try{let e;try{e=await M.get("/user/adoptions",{params:{current_page:1,per_page:100}})}catch(c){m.error(r("api.getAdoptionRecordsFailed")+": "+(c.message||r("unknownError"))),e={success:!1,data:{adoptions:[]}}}e||(e={success:!1,data:{adoptions:[]}});const l=[];if(console.log("é¢†å…»è®°å½•APIå“åº”:",e),e.code===200){const c=e.data.records;console.log("å¤„ç†é¢†å…»è®°å½•æ•°æ®:",c),c.forEach(i=>{i.pid&&l.push({pid:Number(i.pid),name:i.name,species:i.species||"",breed:i.breed})})}console.log("æå–çš„å® ç‰©åˆ—è¡¨:",l),v.value=l}catch(e){console.error(r("api.getPetListFailed"),e),m.error(r("api.getPetListFailed")),v.value=[]}};return{healthAlerts:o,pets:v,loading:E,selectedPet:H,selectedHealthType:k,selectedStatus:b,viewMode:N,showAddModal:p,showEditModal:S,formData:n,totalAlerts:B,normalAlerts:F,criticalAlerts:R,pendingAlerts:U,completedAlerts:$,expiredAlerts:q,filteredAlerts:w,groupedAlerts:z,showAddModalDialog:u,updateAlertStatus:async(e,l)=>{try{await M.put(`/user/health-alerts/${e}/status?status=${l}`),await C(),m.success(r("api.updateSuccess"))}catch{m.error(r("api.updateFailed"))}},deleteAlert:async e=>{try{await ie.confirm(r("api.confirmDeleteHealthAlert"),r("api.deleteConfirmation"),{confirmButtonText:r("api.confirm"),cancelButtonText:r("api.cancel"),type:"warning"}),await M.delete(`/user/health-alerts/${e}`),await C(),m.success(r("api.deleteSuccess"))}catch(l){l!=="cancel"&&(m.error(r("api.deleteFailed")),console.error("åˆ é™¤å¥åº·æé†’å¤±è´¥:",l))}},saveAlert:async()=>{try{if(!n.pid){m.error(r("api.pleaseSelectPet"));return}let e=n.checkDate;n.checkDate&&n.checkDate.includes("T")&&(e=n.checkDate.replace("T"," "));let l=n.reminderTime;n.reminderTime&&n.reminderTime.includes("T")&&(l=n.reminderTime.replace("T"," "));const c={pid:n.pid,healthType:n.healthType,checkDate:e,reminderTime:l||null,status:n.status,description:n.description};let i;n.healthId&&n.healthId>0?i=await M.put(`/user/health-alerts/${n.healthId}`,c):i=await M.post("/user/health-alerts",c),i.data?(m.success(n.healthId?r("api.updateHealthAlertSuccess"):r("api.createHealthAlertSuccess")),p.value=!1,S.value=!1,await C()):m.error(r("api.operationFailed"))}catch(e){console.error(r("api.saveHealthAlertFailed"),e),m.error(r("api.saveHealthAlertFailed"))}},closeModal:()=>{p.value=!1,S.value=!1,n.healthId=0,n.pid=0,n.healthType="",n.checkDate="",n.reminderTime="",n.status="normal",n.description=""},initializeHealthAlerts:async()=>{console.log("å¼€å§‹åˆå§‹åŒ–å¥åº·æé†’æ•°æ®"),await D(),console.log("å® ç‰©æ•°æ®åŠ è½½å®Œæˆ:",v.value),v.value.length>0?(await C(),console.log("å¥åº·æé†’æ•°æ®åŠ è½½å®Œæˆ:",o.value)):(console.log("æ²¡æœ‰å® ç‰©æ•°æ®ï¼Œä¸åŠ è½½å¥åº·æé†’"),o.value=[]),console.log("initializeHealthAlerts: åˆå§‹åŒ–å®Œæˆï¼Œå® ç‰©æ•°é‡:",v.value.length,"å¥åº·æé†’æ•°é‡:",o.value.length)},getStatusClass:e=>{const l=e==="normal"?"normal":e==="critical"?"critical":e;return{pending:l==="normal",completed:l==="normal",expired:l==="critical",normal:l==="normal",critical:l==="critical"}},getHealthTypeLabel:e=>e?{VACCINE:r("healthAlerts.vaccine"),CHECKUP:r("healthAlerts.checkup"),SURGERY:r("healthAlerts.surgery"),DISEASE:r("healthAlerts.disease")}[e]||e:r("healthAlerts.noType","æœªåˆ†ç±»"),getStatusLabel:e=>e?{normal:r("healthAlerts.normal"),critical:r("healthAlerts.critical"),pending:r("healthAlerts.pending"),completed:r("healthAlerts.completed"),expired:r("healthAlerts.expired")}[e]||e:r("healthAlerts.unknown","æœªçŸ¥"),formatDate:e=>{if(!e)return"æœªè®¾ç½®";try{const l=new Date(e);return isNaN(l.getTime())?e:l.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}},editAlert:e=>{n.healthId=e.healthId||e.hid||0,n.pid=Number(e.pid)||0,n.healthType=e.healthType||e.alertType||"",n.checkDate=(e.checkDate||"").replace(" ","T"),n.reminderTime=(e.reminderTime||"").replace(" ","T"),n.status=e.status||"normal",n.description=e.description||e.content||"",S.value=!0},getPetName:e=>{const l=v.value.find(i=>i.pid===e);return l?l.name:"æœªçŸ¥å® ç‰©"}}},ve={class:"page-header"},Ae={class:"stats-grid"},fe={class:"stat-card total"},_e={class:"stat-content"},ge={class:"stat-card normal"},ye={class:"stat-content"},Te={class:"stat-card critical"},ke={class:"stat-content"},be={class:"controls-section"},Se={class:"filter-group"},we={value:""},Ce=["value"],De={value:""},Ie={value:"VACCINE"},Ee={value:"CHECKUP"},He={value:"SURGERY"},Pe={value:"DISEASE"},Me={value:""},Ne={value:"normal"},Re={value:"critical"},Ue={class:"alerts-section"},Le={class:"section-header"},Ve={class:"view-toggle"},xe={key:0,class:"alerts-list"},Fe={class:"alert-header"},$e={class:"pet-info"},qe={key:1,class:"health-type unclassified"},ze={class:"alert-content"},Be={class:"description"},We={class:"alert-meta"},Ge={class:"check-date"},Ke={key:0,class:"reminder-time"},Ye={class:"alert-actions"},je=["onClick"],Oe=["onClick"],Ze={key:1,class:"empty-state"},Je={key:2,class:"timeline-view"},Qe={class:"timeline"},Xe={class:"timeline-date"},et={class:"timeline-items"},tt={class:"timeline-content"},st={class:"timeline-header"},lt={key:1,class:"health-type unclassified"},at={class:"description"},ot={class:"timeline-status"},it={key:0,class:"timeline-reminder"},nt={key:3,class:"empty-state"},rt={class:"modal-header"},ct={class:"form-group"},dt={value:""},ht=["value"],ut={class:"form-group"},pt={value:""},mt={value:"VACCINE"},vt={value:"CHECKUP"},At={value:"SURGERY"},ft={value:"DISEASE"},_t={class:"form-group"},gt={class:"form-group"},yt={value:"normal"},Tt={value:"critical"},kt={class:"form-group"},bt=["placeholder"],St={class:"form-group"},wt={class:"form-help"},Ct={class:"modal-actions"},Dt={type:"submit",class:"save-btn"},It={__name:"Health",setup(r){const{t:o}=ae(),v=pe(),{healthAlerts:E,pets:H,selectedPet:k,selectedHealthType:b,selectedStatus:N,viewMode:p,showAddModal:S,showEditModal:n,formData:u,totalAlerts:B,normalAlerts:F,criticalAlerts:R,filteredAlerts:U,groupedAlerts:$,getPetName:q,getHealthTypeLabel:w,getStatusLabel:z,getStatusClass:C,formatDate:D,editAlert:Z,deleteAlert:J,saveAlert:W,closeModal:y,initializeHealthAlerts:Q}=me(),{createWebSocketConnection:X,closeWebSocketConnection:ee,syncHealthAlertsToStorage:G,checkAndSendReminders:K}=re();let L=null;return ce(async()=>{await Q(),G(E.value);const I=ue();I.info.userId&&X(I.info.userId),console.log("å¯åŠ¨å®šæ—¶æé†’æ£€æŸ¥ï¼ˆæ¯60ç§’ï¼‰"),L=setInterval(()=>{console.log("æ‰§è¡Œå®šæ—¶æé†’æ£€æŸ¥..."),K()},6e4),K()}),de(E,I=>{console.log("å¥åº·æé†’æ•°æ®å˜åŒ–ï¼ŒåŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ–°æ•°é‡:",I.length),G(I)},{deep:!0}),he(()=>{L&&(clearInterval(L),L=null),ee()}),(I,e)=>(h(),d("div",{class:g(["health-alerts-container",{"dark-theme":s(v).preferences.theme==="dark"}])},[t("div",ve,[t("h1",null,a(s(o)("healthAlerts.pageTitle")),1),t("p",null,a(s(o)("healthAlerts.description")),1)]),t("div",Ae,[t("div",fe,[e[17]||(e[17]=t("div",{class:"stat-icon"},"ðŸ“„",-1)),t("div",_e,[t("h3",null,a(s(B)),1),t("p",null,a(s(o)("healthAlerts.totalRecords")),1)])]),t("div",ge,[e[18]||(e[18]=t("div",{class:"stat-icon"},"âœ…",-1)),t("div",ye,[t("h3",null,a(s(F).length),1),t("p",null,a(s(o)("healthAlerts.normalStatus")),1)])]),t("div",Te,[e[19]||(e[19]=t("div",{class:"stat-icon"},"âš ï¸",-1)),t("div",ke,[t("h3",null,a(s(R).length),1),t("p",null,a(s(o)("healthAlerts.criticalStatus")),1)])])]),t("div",be,[t("div",Se,[f(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>j(k)?k.value=l:null),class:"filter-select"},[t("option",we,a(s(o)("healthAlerts.allPets")),1),(h(!0),d(V,null,x(s(H),l=>(h(),d("option",{key:l.pid,value:l.pid},a(l.name),9,Ce))),128))],512),[[P,s(k)]]),f(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>j(b)?b.value=l:null),class:"filter-select"},[t("option",De,a(s(o)("healthAlerts.allTypes")),1),t("option",Ie,a(s(o)("healthAlerts.vaccine")),1),t("option",Ee,a(s(o)("healthAlerts.checkup")),1),t("option",He,a(s(o)("healthAlerts.surgery")),1),t("option",Pe,a(s(o)("healthAlerts.disease")),1)],512),[[P,s(b)]]),f(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>j(N)?N.value=l:null),class:"filter-select"},[t("option",Me,a(s(o)("healthAlerts.allStatus")),1),t("option",Ne,a(s(o)("healthAlerts.normal")),1),t("option",Re,a(s(o)("healthAlerts.critical")),1)],512),[[P,s(N)]])]),t("button",{class:"add-button",onClick:e[3]||(e[3]=()=>{s(y)(),S.value=!0})},[e[20]||(e[20]=t("span",null,"+",-1)),_(" "+a(s(o)("healthAlerts.addHealthRecord")),1)])]),t("div",Ue,[t("div",Le,[t("h2",null,a(s(o)("healthAlerts.title")),1),t("div",Ve,[t("button",{class:g({active:s(p)==="list"}),onClick:e[4]||(e[4]=l=>p.value="list")},a(s(o)("healthAlerts.listView")),3),t("button",{class:g({active:s(p)==="timeline"}),onClick:e[5]||(e[5]=l=>p.value="timeline")},a(s(o)("healthAlerts.timelineView")),3)])]),s(p)==="list"&&s(U).length>0?(h(),d("div",xe,[(h(!0),d(V,null,x(s(U),l=>(h(),d("div",{key:l.healthId||l.hid,class:g(["alert-card",s(C)(l.status)])},[t("div",Fe,[t("div",$e,[t("h4",null,a(s(q)(l.pid)),1),l.healthType||l.alertType?(h(),d("span",{key:0,class:g(["health-type",(l.healthType||l.alertType||"").toLowerCase()])},a(s(w)(l.healthType||l.alertType)),3)):(h(),d("span",qe,a(s(w)(null)),1))]),t("div",{class:g(["alert-status",(l.status||"").toLowerCase()])},a(s(z)(l.status)),3)]),t("div",ze,[t("p",Be,a(l.description||"(æœªå¡«å†™)"),1),t("div",We,[t("span",Ge,[t("strong",null,a(s(o)("healthAlerts.checkTime"))+":",1),_(" "+a(s(D)(l.checkDate)),1)]),l.reminderTime?(h(),d("span",Ke,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),_(" "+a(s(D)(l.reminderTime)),1)])):Y("",!0)])]),t("div",Ye,[t("button",{class:"action-btn edit-btn",onClick:c=>s(Z)(l)},a(s(o)("healthAlerts.editRecord")),9,je),t("button",{class:"action-btn delete-btn",onClick:c=>s(J)(l.healthId||l.hid)},a(s(o)("healthAlerts.deleteRecord")),9,Oe)])],2))),128))])):s(p)==="list"&&s(U).length===0?(h(),d("div",Ze,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)])):s(p)==="timeline"&&Object.keys(s($)).length>0?(h(),d("div",Je,[t("div",Qe,[(h(!0),d(V,null,x(s($),(l,c)=>(h(),d("div",{key:c,class:"timeline-group"},[t("div",Xe,a(s(D)(c)),1),t("div",et,[(h(!0),d(V,null,x(l,i=>(h(),d("div",{key:i.healthId||i.hid,class:g(["timeline-item",s(C)(i.status)])},[e[21]||(e[21]=t("div",{class:"timeline-marker"},null,-1)),t("div",tt,[t("div",st,[t("h4",null,a(s(q)(i.pid)),1),i.healthType||i.alertType?(h(),d("span",{key:0,class:g(["health-type",(i.healthType||i.alertType||"").toLowerCase()])},a(s(w)(i.healthType||i.alertType)),3)):(h(),d("span",lt,a(s(w)(null)),1))]),t("p",at,a(i.description||"(æœªå¡«å†™)"),1),t("div",ot,[t("span",{class:g((i.status||"").toLowerCase())},a(s(z)(i.status)),3)]),i.reminderTime?(h(),d("div",it,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),_(" "+a(s(D)(i.reminderTime)),1)])):Y("",!0)])],2))),128))])]))),128))])])):(h(),d("div",nt,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)]))]),s(S)||s(n)?(h(),d("div",{key:0,class:"modal-overlay",onClick:e[16]||(e[16]=(...l)=>s(y)&&s(y)(...l))},[t("div",{class:"modal-content",onClick:e[15]||(e[15]=le(()=>{},["stop"]))},[t("div",rt,[t("h3",null,a(s(n)?s(o)("healthAlerts.editHealthRecord"):s(o)("healthAlerts.addHealthRecord")),1),t("button",{class:"close-btn",onClick:e[6]||(e[6]=(...l)=>s(y)&&s(y)(...l))},"Ã—")]),t("form",{onSubmit:e[14]||(e[14]=le((...l)=>s(W)&&s(W)(...l),["prevent"])),class:"modal-form"},[t("div",ct,[t("label",null,[_(a(s(o)("healthAlerts.petName")),1),e[22]||(e[22]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>s(u).pid=l),required:"",class:"form-select"},[t("option",dt,a(s(o)("healthAlerts.selectPet")),1),(h(!0),d(V,null,x(s(H),l=>(h(),d("option",{key:l.pid,value:l.pid},a(l.name),9,ht))),128))],512),[[P,s(u).pid]])]),t("div",ut,[t("label",null,[_(a(s(o)("healthAlerts.healthType")),1),e[23]||(e[23]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[8]||(e[8]=l=>s(u).healthType=l),required:"",class:"form-select"},[t("option",pt,a(s(o)("healthAlerts.selectType")),1),t("option",mt,a(s(o)("healthAlerts.vaccine")),1),t("option",vt,a(s(o)("healthAlerts.checkup")),1),t("option",At,a(s(o)("healthAlerts.surgery")),1),t("option",ft,a(s(o)("healthAlerts.disease")),1)],512),[[P,s(u).healthType]])]),t("div",_t,[t("label",null,[_(a(s(o)("healthAlerts.checkTime")),1),e[24]||(e[24]=t("span",{class:"required"},"*",-1))]),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[9]||(e[9]=l=>s(u).checkDate=l),required:"",class:"form-input"},null,512),[[O,s(u).checkDate]])]),t("div",gt,[t("label",null,[_(a(s(o)("healthAlerts.healthStatus")),1),e[25]||(e[25]=t("span",{class:"required"},"*",-1))]),f(t("select",{"onUpdate:modelValue":e[10]||(e[10]=l=>s(u).status=l),required:"",class:"form-select"},[t("option",yt,a(s(o)("healthAlerts.normal")),1),t("option",Tt,a(s(o)("healthAlerts.critical")),1)],512),[[P,s(u).status]])]),t("div",kt,[t("label",null,[_(a(s(o)("healthAlerts.descriptionLabel")),1),e[26]||(e[26]=t("span",{class:"required"},"*",-1))]),f(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=l=>s(u).description=l),placeholder:s(o)("healthAlerts.descriptionPlaceholder"),class:"form-textarea",rows:"3"},null,8,bt),[[O,s(u).description]])]),t("div",St,[t("label",null,a(s(o)("healthAlerts.reminderTime")),1),f(t("input",{type:"datetime-local","onUpdate:modelValue":e[12]||(e[12]=l=>s(u).reminderTime=l),class:"form-input"},null,512),[[O,s(u).reminderTime]]),t("small",wt,a(s(o)("healthAlerts.ifNotSet")),1)]),t("div",Ct,[t("button",{type:"button",class:"cancel-btn",onClick:e[13]||(e[13]=(...l)=>s(y)&&s(y)(...l))},a(s(o)("healthAlerts.cancel")),1),t("button",Dt,a(s(n)?s(o)("healthAlerts.update"):s(o)("healthAlerts.save")),1)])],32)])])):Y("",!0)],2))}},Nt=ne(It,[["__scopeId","data-v-27db2142"]]);export{Nt as default};
