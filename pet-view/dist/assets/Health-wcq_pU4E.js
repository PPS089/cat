import{u as ae,h as f,j as oe,I as S,E as p,J as ie,_ as re,X as ne,v as de,x as ce,Y as he,c,o as h,a as t,z as Y,t as a,l as s,N as _,Z as P,U as O,F as V,f as x,g,n as y,$ as le,a0 as J}from"./index-BIX1Ehmq.js";import{s as N}from"./request-DUfzvZFe.js";import{u as ue}from"./user-DQjmLxXu.js";import{useThemeStore as pe}from"./theme-cTCRAQz8.js";const me=()=>{const{t:i}=ae(),o=f([]),A=f([]),E=f(!1),M=f(""),b=f(""),w=f(""),F=f("list"),v=f(!1),D=f(!1),n=oe({healthId:0,pid:0,healthType:"",checkDate:"",description:"",reminderTime:void 0,status:"normal"}),m=()=>{if(A.value.length===0){p.warning(i("noAssociatedPetPleaseAdoptOrFoster"));return}v.value=!0},G=S(()=>o.value.length),$=S(()=>o.value.filter(e=>e.status==="normal")),R=S(()=>o.value.filter(e=>e.status==="critical")),U=S(()=>$.value),q=S(()=>R.value),z=S(()=>R.value),C=S(()=>{let e=o.value;return M.value&&(e=e.filter(l=>l.pid===Number(M.value))),b.value&&(e=e.filter(l=>l.healthType===b.value)),w.value&&(e=e.filter(l=>l.status===w.value)),e.sort((l,d)=>new Date(d.checkDate).getTime()-new Date(l.checkDate).getTime())}),B=S(()=>{const e={};return C.value.forEach(l=>{const d=new Date(l.checkDate).toDateString();e[d]||(e[d]=[]),e[d].push(l)}),e}),H=async()=>{E.value=!0;try{const e=await N.get("/user/health-alerts");await T();const l=A.value.map(d=>d.pid);if(console.log("ç”¨æˆ·æ‹¥æœ‰çš„å® ç‰©IDåˆ—è¡¨:",l),e&&e.data&&e.data.alerts&&Array.isArray(e.data.alerts)){const d=e.data.alerts;o.value=d.filter(r=>{const u=Number(r.pid),se=l.includes(u);return console.log(`è¿‡æ»¤æ£€æŸ¥ - alertPid: ${u}, ç”¨æˆ·å® ç‰©: ${se}`),se}).map(r=>(console.log("å¥åº·æé†’alertæ•°æ®:",r),{healthId:r.healthId,pid:Number(r.pid),checkDate:r.checkDate,healthType:r.healthType,description:r.description,reminderTime:r.reminderTime,status:r.status,createdAt:r.createdAt,updatedAt:r.updatedAt}))}console.log("è¿‡æ»¤åŽçš„å¥åº·è­¦æŠ¥æ•°æ®:",o.value)}catch{p.error(i("api.getPetListFailed")),o.value=[]}finally{E.value=!1}},T=async()=>{try{let e;try{e=await N.get("/user/adoptions",{params:{current_page:1,per_page:100}})}catch(d){p.error(i("api.getAdoptionRecordsFailed")+": "+(d.message||i("unknownError"))),e={success:!1,data:{adoptions:[]}}}e||(e={success:!1,data:{adoptions:[]}});const l=[];if(console.log("é¢†å…»è®°å½•APIå“åº”:",e),e.code===200){const d=e.data.records;console.log("å¤„ç†é¢†å…»è®°å½•æ•°æ®:",d),d.forEach(r=>{r.pid&&l.push({pid:Number(r.pid),name:r.name,species:r.species||"",breed:r.breed})})}console.log("æå–çš„å® ç‰©åˆ—è¡¨:",l),A.value=l}catch(e){console.error(i("api.getPetListFailed"),e),p.error(i("api.getPetListFailed")),A.value=[]}};return{healthAlerts:o,pets:A,loading:E,selectedPet:M,selectedHealthType:b,selectedStatus:w,viewMode:F,showAddModal:v,showEditModal:D,formData:n,totalAlerts:G,normalAlerts:$,criticalAlerts:R,pendingAlerts:U,completedAlerts:q,expiredAlerts:z,filteredAlerts:C,groupedAlerts:B,showAddModalDialog:m,updateAlertStatus:async(e,l)=>{try{await N.put(`/user/health-alerts/${e}/status?status=${l}`),await H(),p.success(i("api.updateHealthAlertSuccess"))}catch(d){console.error(i("api.updateHealthAlertFailed"),d),d.response&&d.response.status===400?p.error(i("api.updateHealthAlertFailed")+": "+(d.response.data?.message||i("common.validationError"))):p.error(i("api.updateHealthAlertFailed"))}},deleteAlert:async e=>{try{await ie.confirm(i("api.confirmDeleteHealthAlert"),i("api.deleteConfirmation"),{confirmButtonText:i("api.confirm"),cancelButtonText:i("api.cancel"),type:"warning"}),await N.delete(`/user/health-alerts/${e}`),await H(),p.success(i("api.deleteSuccess"))}catch(l){l!=="cancel"&&(p.error(i("api.deleteFailed")),console.error("åˆ é™¤å¥åº·æé†’å¤±è´¥:",l))}},saveAlert:async()=>{try{if(!n.pid){p.error(i("api.pleaseSelectPet"));return}let e=n.checkDate;if(n.checkDate&&n.checkDate.includes("T")){const u=new Date(n.checkDate);e=u.getFullYear()+"-"+String(u.getMonth()+1).padStart(2,"0")+"-"+String(u.getDate()).padStart(2,"0")+" "+String(u.getHours()).padStart(2,"0")+":"+String(u.getMinutes()).padStart(2,"0")+":"+String(u.getSeconds()).padStart(2,"0")}let l=n.reminderTime||null;if(n.reminderTime&&n.reminderTime.includes("T")){const u=new Date(n.reminderTime);l=u.getFullYear()+"-"+String(u.getMonth()+1).padStart(2,"0")+"-"+String(u.getDate()).padStart(2,"0")+" "+String(u.getHours()).padStart(2,"0")+":"+String(u.getMinutes()).padStart(2,"0")+":"+String(u.getSeconds()).padStart(2,"0")}const d={pid:n.pid,healthType:n.healthType,checkDate:e,reminderTime:l,status:n.status,description:n.description};let r;n.healthId&&n.healthId>0?r=await N.put(`/user/health-alerts/${n.healthId}`,d):r=await N.post("/user/health-alerts",d),r.data?(p.success(n.healthId?i("api.updateHealthAlertSuccess"):i("api.createHealthAlertSuccess")),v.value=!1,D.value=!1,await H()):p.error(i("api.operationFailed"))}catch(e){console.error(i("api.saveHealthAlertFailed"),e),n.healthId&&n.healthId>0?e.response&&e.response.status===400?p.error(i("api.updateHealthAlertFailed")+": "+(e.response.data?.message||i("common.validationError"))):p.error(i("api.updateHealthAlertFailed")):e.response&&e.response.status===400?p.error(i("api.saveHealthAlertFailed")+": "+(e.response.data?.message||i("common.validationError"))):p.error(i("api.saveHealthAlertFailed"))}},closeModal:()=>{v.value=!1,D.value=!1,n.healthId=0,n.pid=0,n.healthType="",n.checkDate="",n.reminderTime=void 0,n.status="normal",n.description=""},initializeHealthAlerts:async()=>{console.log("å¼€å§‹åˆå§‹åŒ–å¥åº·æé†’æ•°æ®"),await T(),console.log("å® ç‰©æ•°æ®åŠ è½½å®Œæˆ:",A.value),A.value.length>0?(await H(),console.log("å¥åº·æé†’æ•°æ®åŠ è½½å®Œæˆ:",o.value)):(console.log("æ²¡æœ‰å® ç‰©æ•°æ®ï¼Œä¸åŠ è½½å¥åº·æé†’"),o.value=[]),console.log("initializeHealthAlerts: åˆå§‹åŒ–å®Œæˆï¼Œå® ç‰©æ•°é‡:",A.value.length,"å¥åº·æé†’æ•°é‡:",o.value.length)},getStatusClass:e=>{const l=e==="normal"?"normal":e==="critical"?"critical":e;return{pending:l==="normal",completed:l==="normal",expired:l==="critical",normal:l==="normal",critical:l==="critical"}},getHealthTypeLabel:e=>e?{VACCINE:i("healthAlerts.vaccine"),CHECKUP:i("healthAlerts.checkup"),SURGERY:i("healthAlerts.surgery"),DISEASE:i("healthAlerts.disease")}[e]||e:i("healthAlerts.noType","æœªåˆ†ç±»"),getStatusLabel:e=>e?{normal:i("healthAlerts.normal"),critical:i("healthAlerts.critical"),pending:i("healthAlerts.pending"),completed:i("healthAlerts.completed"),expired:i("healthAlerts.expired")}[e]||e:i("healthAlerts.unknown","æœªçŸ¥"),formatDate:e=>{if(!e)return"æœªè®¾ç½®";try{const l=new Date(e);return isNaN(l.getTime())?e:l.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}},editAlert:e=>{n.healthId=e.healthId||e.hid||0,n.pid=Number(e.pid)||0,n.healthType=e.healthType||e.alertType||"",n.checkDate=(e.checkDate||"").replace(" ","T"),n.reminderTime=(e.reminderTime||"").replace(" ","T"),n.status=e.status||"normal",n.description=e.description||e.content||"",D.value=!0},getPetName:e=>{const l=A.value.find(r=>r.pid===e);return l?l.name:"æœªçŸ¥å® ç‰©"}}},ve={class:"page-header"},Ae={class:"stats-grid"},ge={class:"stat-card total"},fe={class:"stat-content"},_e={class:"stat-card normal"},ye={class:"stat-content"},Te={class:"stat-card critical"},ke={class:"stat-content"},Se={class:"controls-section"},be={class:"filter-group"},we={value:""},De=["value"],Ce={value:""},He={value:"VACCINE"},Ie={value:"CHECKUP"},Ee={value:"SURGERY"},Me={value:"DISEASE"},Pe={value:""},Ne={value:"normal"},Fe={value:"critical"},Re={class:"alerts-section"},Ue={class:"section-header"},Le={class:"view-toggle"},Ve={key:0,class:"alerts-list"},xe={class:"alert-header"},$e={class:"pet-info"},qe={key:1,class:"health-type unclassified"},ze={class:"alert-content"},Be={class:"description"},Ye={class:"alert-meta"},Ge={class:"check-date"},Ke={key:0,class:"reminder-time"},We={key:1,class:"updated-time"},je={class:"alert-actions"},Oe=["onClick"],Je=["onClick"],Xe={key:1,class:"empty-state"},Ze={key:2,class:"timeline-view"},Qe={class:"timeline"},et={class:"timeline-date"},tt={class:"timeline-items"},st={class:"timeline-content"},lt={class:"timeline-header"},at={key:1,class:"health-type unclassified"},ot={class:"description"},it={class:"timeline-status"},rt={key:0,class:"timeline-reminder"},nt={key:3,class:"empty-state"},dt={class:"modal-header"},ct={class:"form-group"},ht={value:""},ut=["value"],pt={class:"form-group"},mt={value:""},vt={value:"VACCINE"},At={value:"CHECKUP"},gt={value:"SURGERY"},ft={value:"DISEASE"},_t={class:"form-group"},yt={class:"form-group"},Tt={value:"normal"},kt={value:"critical"},St={class:"form-group"},bt=["placeholder"],wt={class:"form-group"},Dt={class:"form-help"},Ct={class:"modal-actions"},Ht={type:"submit",class:"save-btn"},It={__name:"Health",setup(i){const{t:o}=ae(),A=pe(),{healthAlerts:E,pets:M,selectedPet:b,selectedHealthType:w,selectedStatus:F,viewMode:v,showAddModal:D,showEditModal:n,formData:m,totalAlerts:G,normalAlerts:$,criticalAlerts:R,filteredAlerts:U,groupedAlerts:q,getPetName:z,getHealthTypeLabel:C,getStatusLabel:B,getStatusClass:H,formatDate:T,editAlert:X,deleteAlert:Z,saveAlert:K,closeModal:k,initializeHealthAlerts:Q}=me(),{createWebSocketConnection:ee,closeWebSocketConnection:te,syncHealthAlertsToStorage:W,checkAndSendReminders:j}=ne();let L=null;return de(async()=>{await Q(),W(E.value);const I=ue();I.info.userId&&ee(I.info.userId),console.log("å¯åŠ¨å®šæ—¶æé†’æ£€æŸ¥ï¼ˆæ¯60ç§’ï¼‰"),L=setInterval(()=>{console.log("æ‰§è¡Œå®šæ—¶æé†’æ£€æŸ¥..."),j()},6e4),j()}),ce(E,I=>{console.log("å¥åº·æé†’æ•°æ®å˜åŒ–ï¼ŒåŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ–°æ•°é‡:",I.length),W(I)},{deep:!0}),he(()=>{L&&(clearInterval(L),L=null),te()}),(I,e)=>(h(),c("div",{class:y(["health-alerts-container",{"dark-theme":s(A).preferences.theme==="dark"}])},[t("div",ve,[t("h1",null,a(s(o)("healthAlerts.pageTitle")),1),t("p",null,a(s(o)("healthAlerts.description")),1)]),t("div",Ae,[t("div",ge,[e[17]||(e[17]=t("div",{class:"stat-icon"},"ðŸ“„",-1)),t("div",fe,[t("h3",null,a(s(G)),1),t("p",null,a(s(o)("healthAlerts.totalRecords")),1)])]),t("div",_e,[e[18]||(e[18]=t("div",{class:"stat-icon"},"âœ…",-1)),t("div",ye,[t("h3",null,a(s($).length),1),t("p",null,a(s(o)("healthAlerts.normalStatus")),1)])]),t("div",Te,[e[19]||(e[19]=t("div",{class:"stat-icon"},"âš ï¸",-1)),t("div",ke,[t("h3",null,a(s(R).length),1),t("p",null,a(s(o)("healthAlerts.criticalStatus")),1)])])]),t("div",Se,[t("div",be,[_(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>O(b)?b.value=l:null),class:"filter-select"},[t("option",we,a(s(o)("healthAlerts.allPets")),1),(h(!0),c(V,null,x(s(M),l=>(h(),c("option",{key:l.pid,value:l.pid},a(l.name),9,De))),128))],512),[[P,s(b)]]),_(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>O(w)?w.value=l:null),class:"filter-select"},[t("option",Ce,a(s(o)("healthAlerts.allTypes")),1),t("option",He,a(s(o)("healthAlerts.vaccine")),1),t("option",Ie,a(s(o)("healthAlerts.checkup")),1),t("option",Ee,a(s(o)("healthAlerts.surgery")),1),t("option",Me,a(s(o)("healthAlerts.disease")),1)],512),[[P,s(w)]]),_(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>O(F)?F.value=l:null),class:"filter-select"},[t("option",Pe,a(s(o)("healthAlerts.allStatus")),1),t("option",Ne,a(s(o)("healthAlerts.normal")),1),t("option",Fe,a(s(o)("healthAlerts.critical")),1)],512),[[P,s(F)]])]),t("button",{class:"add-button",onClick:e[3]||(e[3]=()=>{s(k)(),D.value=!0})},[e[20]||(e[20]=t("span",null,"+",-1)),g(" "+a(s(o)("healthAlerts.addHealthRecord")),1)])]),t("div",Re,[t("div",Ue,[t("h2",null,a(s(o)("healthAlerts.title")),1),t("div",Le,[t("button",{class:y({active:s(v)==="list"}),onClick:e[4]||(e[4]=l=>v.value="list")},a(s(o)("healthAlerts.listView")),3),t("button",{class:y({active:s(v)==="timeline"}),onClick:e[5]||(e[5]=l=>v.value="timeline")},a(s(o)("healthAlerts.timelineView")),3)])]),s(v)==="list"&&s(U).length>0?(h(),c("div",Ve,[(h(!0),c(V,null,x(s(U),l=>(h(),c("div",{key:l.healthId||l.hid,class:y(["alert-card",s(H)(l.status)])},[t("div",xe,[t("div",$e,[t("h4",null,a(s(z)(l.pid)),1),l.healthType||l.alertType?(h(),c("span",{key:0,class:y(["health-type",(l.healthType||l.alertType||"").toLowerCase()])},a(s(C)(l.healthType||l.alertType)),3)):(h(),c("span",qe,a(s(C)(null)),1))]),t("div",{class:y(["alert-status",(l.status||"").toLowerCase()])},a(s(B)(l.status)),3)]),t("div",ze,[t("p",Be,a(l.description||"(æœªå¡«å†™)"),1),t("div",Ye,[t("span",Ge,[t("strong",null,a(s(o)("healthAlerts.checkTime"))+":",1),g(" "+a(s(T)(l.checkDate)),1)]),l.reminderTime?(h(),c("span",Ke,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),g(" "+a(s(T)(l.reminderTime)),1)])):Y("",!0),l.updatedAt&&l.updatedAt!==l.checkDate?(h(),c("span",We,[e[21]||(e[21]=t("strong",null,"æ›´æ–°æ—¶é—´:",-1)),g(" "+a(s(T)(l.updatedAt)),1)])):Y("",!0)])]),t("div",je,[t("button",{class:"action-btn edit-btn",onClick:d=>s(X)(l)},a(s(o)("healthAlerts.editRecord")),9,Oe),t("button",{class:"action-btn delete-btn",onClick:d=>s(Z)(l.healthId||l.hid)},a(s(o)("healthAlerts.deleteRecord")),9,Je)])],2))),128))])):s(v)==="list"&&s(U).length===0?(h(),c("div",Xe,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)])):s(v)==="timeline"&&Object.keys(s(q)).length>0?(h(),c("div",Ze,[t("div",Qe,[(h(!0),c(V,null,x(s(q),(l,d)=>(h(),c("div",{key:d,class:"timeline-group"},[t("div",et,a(s(T)(d)),1),t("div",tt,[(h(!0),c(V,null,x(l,r=>(h(),c("div",{key:r.healthId||r.hid,class:y(["timeline-item",s(H)(r.status)])},[e[22]||(e[22]=t("div",{class:"timeline-marker"},null,-1)),t("div",st,[t("div",lt,[t("h4",null,a(s(z)(r.pid)),1),r.healthType||r.alertType?(h(),c("span",{key:0,class:y(["health-type",(r.healthType||r.alertType||"").toLowerCase()])},a(s(C)(r.healthType||r.alertType)),3)):(h(),c("span",at,a(s(C)(null)),1))]),t("p",ot,a(r.description||"(æœªå¡«å†™)"),1),t("div",it,[t("span",{class:y((r.status||"").toLowerCase())},a(s(B)(r.status)),3)]),r.reminderTime?(h(),c("div",rt,[t("strong",null,a(s(o)("healthAlerts.reminderTime"))+":",1),g(" "+a(s(T)(r.reminderTime)),1)])):Y("",!0)])],2))),128))])]))),128))])])):(h(),c("div",nt,[t("p",null,"ðŸ“„ "+a(s(o)("healthAlerts.noRecords")),1)]))]),s(D)||s(n)?(h(),c("div",{key:0,class:"modal-overlay",onClick:e[16]||(e[16]=(...l)=>s(k)&&s(k)(...l))},[t("div",{class:"modal-content",onClick:e[15]||(e[15]=le(()=>{},["stop"]))},[t("div",dt,[t("h3",null,a(s(n)?s(o)("healthAlerts.editHealthRecord"):s(o)("healthAlerts.addHealthRecord")),1),t("button",{class:"close-btn",onClick:e[6]||(e[6]=(...l)=>s(k)&&s(k)(...l))},"Ã—")]),t("form",{onSubmit:e[14]||(e[14]=le((...l)=>s(K)&&s(K)(...l),["prevent"])),class:"modal-form"},[t("div",ct,[t("label",null,[g(a(s(o)("healthAlerts.petName")),1),e[23]||(e[23]=t("span",{class:"required"},"*",-1))]),_(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>s(m).pid=l),required:"",class:"form-select"},[t("option",ht,a(s(o)("healthAlerts.selectPet")),1),(h(!0),c(V,null,x(s(M),l=>(h(),c("option",{key:l.pid,value:l.pid},a(l.name),9,ut))),128))],512),[[P,s(m).pid]])]),t("div",pt,[t("label",null,[g(a(s(o)("healthAlerts.healthType")),1),e[24]||(e[24]=t("span",{class:"required"},"*",-1))]),_(t("select",{"onUpdate:modelValue":e[8]||(e[8]=l=>s(m).healthType=l),required:"",class:"form-select"},[t("option",mt,a(s(o)("healthAlerts.selectType")),1),t("option",vt,a(s(o)("healthAlerts.vaccine")),1),t("option",At,a(s(o)("healthAlerts.checkup")),1),t("option",gt,a(s(o)("healthAlerts.surgery")),1),t("option",ft,a(s(o)("healthAlerts.disease")),1)],512),[[P,s(m).healthType]])]),t("div",_t,[t("label",null,[g(a(s(o)("healthAlerts.checkTime")),1),e[25]||(e[25]=t("span",{class:"required"},"*",-1))]),_(t("input",{type:"datetime-local","onUpdate:modelValue":e[9]||(e[9]=l=>s(m).checkDate=l),required:"",class:"form-input"},null,512),[[J,s(m).checkDate]])]),t("div",yt,[t("label",null,[g(a(s(o)("healthAlerts.healthStatus")),1),e[26]||(e[26]=t("span",{class:"required"},"*",-1))]),_(t("select",{"onUpdate:modelValue":e[10]||(e[10]=l=>s(m).status=l),required:"",class:"form-select"},[t("option",Tt,a(s(o)("healthAlerts.normal")),1),t("option",kt,a(s(o)("healthAlerts.critical")),1)],512),[[P,s(m).status]])]),t("div",St,[t("label",null,[g(a(s(o)("healthAlerts.descriptionLabel")),1),e[27]||(e[27]=t("span",{class:"required"},"*",-1))]),_(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=l=>s(m).description=l),placeholder:s(o)("healthAlerts.descriptionPlaceholder"),class:"form-textarea",rows:"3"},null,8,bt),[[J,s(m).description]])]),t("div",wt,[t("label",null,a(s(o)("healthAlerts.reminderTime")),1),_(t("input",{type:"datetime-local","onUpdate:modelValue":e[12]||(e[12]=l=>s(m).reminderTime=l),class:"form-input"},null,512),[[J,s(m).reminderTime]]),t("small",Dt,a(s(o)("healthAlerts.ifNotSet")),1)]),t("div",Ct,[t("button",{type:"button",class:"cancel-btn",onClick:e[13]||(e[13]=(...l)=>s(k)&&s(k)(...l))},a(s(o)("healthAlerts.cancel")),1),t("button",Ht,a(s(n)?s(o)("healthAlerts.update"):s(o)("healthAlerts.save")),1)])],32)])])):Y("",!0)],2))}},Ft=re(It,[["__scopeId","data-v-6fce077b"]]);export{Ft as default};
