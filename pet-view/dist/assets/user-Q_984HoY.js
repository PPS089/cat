import{u as L,h as N,j as U,I as R,k as T,E as l,ad as _}from"./index-BSW2uGQz.js";import{s as w}from"./request-qgYNvrL7.js";const I="/src/assets/img/dog.jpg",A="/api/images/",O=2*1024*1024,j=["jpg","jpeg","png","gif","webp","bmp"],$=/^1[3-9]\d{9}$/,V=5e3,x=1e3,E=async()=>{try{const o=localStorage.getItem("userId");return!localStorage.getItem("token")||!o?(console.warn("用户未登录"),{success:!1,message:`${o}用户未登录`}):{success:!0,data:(await w.get("/user/profile")).data}}catch(o){return console.error("从API获取用户资料失败:",o),{success:!1,message:"获取用户资料失败"}}},q=()=>{const{t:o}=L(),n=J(),u=N(),s=N(!1),t=U({userName:"",email:"",phone:"",headPic:"",introduce:""}),c=N(null),v=R(()=>({username:[{required:!0,message:o("user.usernameRequired"),trigger:"blur"},{min:3,max:20,message:o("user.usernameLength"),trigger:"blur"}],email:[{required:!0,message:o("user.emailRequired"),trigger:"blur"},{type:"email",message:o("user.emailInvalid"),trigger:"blur"}],phone:[{pattern:$,message:o("user.phoneInvalid"),trigger:"blur"}],bio:[{max:200,message:o("user.bioMax"),trigger:"blur"}]})),P=r=>{const a=r.name.split(".").pop()?.toLowerCase()||"",i=j.includes(a),f=r.size<O;return i?f?!0:(l.error(o("message.avatarSizeError")),!1):(l.error(o("message.avatarFormatError")),!1)},y=async r=>{const a=r.file;if(!P(a))return;c.value=a;const i=new FileReader;i.onload=f=>{t.headPic=f.target?.result},i.onerror=()=>{l.error(o("avatarPreviewFailed")),t.headPic=I},i.readAsDataURL(a)},p=r=>new Promise(a=>{const i=new Image;i.onload=()=>{console.log("头像测试加载成功:",r),a(!0)},i.onerror=()=>{console.log("头像测试加载失败:",r),a(!1)},i.src=r,setTimeout(()=>{console.log("头像测试加载超时:",r),a(!1)},V)}),e=(r,a=!1)=>{t.userName=r.userName||"",t.email=r.email||"",t.phone=r.phone||"",t.introduce=r.introduce||"",a&&r.headPic?t.headPic=`${A}${r.headPic}`:t.headPic=r.headPic||I},m=async()=>{try{if(console.log("开始加载用户资料，store.info:",n.info),n.info&&n.info.userId&&n.info.userId!==0)console.log("使用store中的用户信息:",n.info),e(n.info);else{console.log("store中用户信息不完整，从API获取...");const r=await E();if(console.log("API响应:",r),r.success&&r.data){const a=r.data;console.log("获取到的用户数据:",a),e(a,!0),n.setUserProfile({userName:a.userName,headPic:a.headPic?`${A}${a.headPic}`:I,email:a.email,phone:a.phone,introduce:a.introduce})}else console.error("API返回数据无效:",r),l.error("获取用户资料失败")}}catch(r){console.error("获取用户信息失败:",r),l.error(o("message.getUserInfoFailed"))}},F=async()=>{u.value&&await u.value.validate(async r=>{if(r){s.value=!0;try{const a=n.info,i=new FormData;c.value&&i.append("avatar",c.value);const f=[{field:"userName",formValue:t.userName||""},{field:"email",formValue:t.email||""},{field:"phone",formValue:t.phone||""},{field:"introduce",formValue:t.introduce||""}];let S=!!c.value;if(f.forEach(({field:g,formValue:d})=>{d!==a[g]&&(i.append(g,d),S=!0)}),!S){l.info(o("user.noChanges")),s.value=!1;return}const h=await w.put("/user/profile",i);if(h.code===200){const g={userName:t.userName,email:t.email,phone:t.phone,introduce:t.introduce};let d;h.data?.headPic?d=`${A}${h.data.headPic}`:c.value&&(d=t.headPic||void 0),d?.trim()?(console.log("检测到新头像，开始可用性验证:",d),setTimeout(async()=>{console.log("延迟验证新头像可用性..."),await p(d)?(console.log("新头像验证成功，更新store"),g.headPic=d,n.setUserProfile(g),l.success(o("user.profileUpdated"))):(console.log("新头像验证失败，使用默认头像"),g.headPic=n.info.headPic||I,n.setUserProfile(g),l.warning("头像更新可能存在延迟，如长时间未显示请刷新页面")),c.value=null},x)):(n.setUserProfile(g),l.success(o("user.profileUpdated")))}else l.error(h.message||o("user.updateFailed"))}catch(a){console.error("资料更新失败:",a),l.error(a.response?.data?.message||o("user.updateFailed"))}finally{s.value=!1}}})};function b(){e(n.info),l.success(o("user.formReset"))}return T(()=>{m()}),{t:o,profileFormRef:u,loading:s,profileForm:t,pendingAvatarFile:c,computedRules:v,beforeImageUpload:P,handleImageUpload:y,testImageLoad:p,loadUserProfile:m,submitForm:F,resetForm:b}},J=_("user",()=>{const o=localStorage.getItem("userInfo"),n=localStorage.getItem("userId");let u;if(o)try{u=JSON.parse(o),!u.userId&&n&&(u.userId=parseInt(n))}catch(e){console.error("解析存储的用户信息失败:",e),u={userName:"",headPic:"/src/assets/img/dog.jpg",userId:n?parseInt(n):0,email:"",phone:"",introduce:""}}else u={userName:"",headPic:"/src/assets/img/dog.jpg",userId:n?parseInt(n):0,email:"",phone:"",introduce:""};const s=U(u);let t=!1,c=null;return{info:s,fetchProfile:async()=>t&&c?(console.log("用户资料请求已在进行中，等待现有请求完成"),c):s.userId&&s.userId!==0&&s.userName&&s.userName!==""?(console.log("用户资料已存在且完整，跳过请求"),Promise.resolve()):(s.userId&&s.userId!==0&&(!s.userName||s.userName==="")&&console.log("用户ID存在但信息不完整，需要获取完整资料"),t=!0,c=(async()=>{try{const e=await E();e.success?(console.log("用户数据结构:",JSON.stringify(e.data,null,2)),typeof e.data=="object"&&e.data!==null?(s.userName="",s.headPic="/src/assets/img/dog.jpg",s.email="",s.phone="",s.introduce="",s.userName=e.data.userName||"",s.headPic=e.data.headPic?`/api/images/${e.data.headPic}`:"/src/assets/img/dog.jpg",s.email=e.data.email||"",s.phone=e.data.phone||"",s.introduce=e.data.introduce||"",e.data.userId?(s.userId=e.data.userId,console.log("从API获取到userId:",e.data.userId)):console.log("API返回的用户数据中没有userId字段")):(console.log("API返回的数据不是对象，可能是:",typeof e.data,e.data),typeof e.data=="number"&&(console.log("API返回的是数字，假设为userId:",e.data),s.userId=e.data)),localStorage.setItem("userInfo",JSON.stringify(s)),console.log("用户资料获取成功 - 用户名:",s.userName,"用户ID:",s.userId),console.log("完整的用户信息:",JSON.stringify(s,null,2))):l.error(e.message||"获取用户资料失败")}catch(e){console.error("获取用户资料失败:",e),l.error("获取用户资料失败")}finally{t=!1,c=null}})(),c),changePassword:async e=>{try{const m=await w.put("/user/updatePassword",{currentPassword:e.currentPassword,newPassword:e.newPassword});if(m.code===200)return{success:!0,message:"密码修改成功"};throw new Error(m?.message||"密码修改失败")}catch(m){throw console.error("修改密码失败:",m),m}},setUserProfile:e=>{e.userName&&(s.userName=e.userName,localStorage.setItem("userName",s.userName),console.log("用户名已更新:",s.userName)),e.headPic&&(s.headPic=e.headPic,localStorage.setItem("headPic",s.headPic),console.log("头像已更新:",s.headPic)),e.email!==void 0&&(s.email=e.email,localStorage.setItem("email",e.email),console.log("邮箱已更新:",e.email)),e.phone!==void 0&&(s.phone=e.phone,localStorage.setItem("phone",e.phone),console.log("电话已更新:",e.phone)),e.introduce!==void 0&&(s.introduce=e.introduce,localStorage.setItem("introduce",e.introduce),console.log("简介已更新:",e.introduce)),localStorage.setItem("userInfo",JSON.stringify(s)),console.log("完整的用户信息已同步到localStorage:",JSON.stringify(s,null,2))},setUsername:e=>{s.userName=e,localStorage.setItem("userName",e)}}});export{q as a,J as u};
