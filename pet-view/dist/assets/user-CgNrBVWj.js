import{u as L,h as w,j as E,I as _,k as O,E as n,ad as R}from"./index-C-QPrTeL.js";import{s as v}from"./request-C9ntlt9z.js";const P="/src/assets/img/dog.jpg",S="/api/images/",T=2*1024*1024,j=["jpg","jpeg","png","gif","webp","bmp"],$=/^1[3-9]\d{9}$/,J=5e3,V=1e3,F=async()=>{try{const o=localStorage.getItem("userId");return!localStorage.getItem("jwt_token")||!o?(console.warn("用户未登录或缺少必要信息"),{success:!1,data:null,message:"用户未登录或缺少必要信息"}):{success:!0,data:(await v.get("/user/profile")).data,message:"获取用户资料成功"}}catch(o){return console.error("从API获取用户资料失败:",o),o.response&&(o.response.status===401||o.response.status===403)?{success:!1,data:null,message:"用户未登录或缺少必要信息"}:{success:!1,data:null,message:"获取用户资料失败"}}},q=()=>{const{t:o}=L(),t=x(),m=w(),l=w(!1),e=E({userName:"",email:"",phone:"",headPic:"",introduce:""}),i=w(null),g=_(()=>({username:[{required:!0,message:o("user.usernameRequired"),trigger:"blur"},{min:3,max:20,message:o("user.usernameLength"),trigger:"blur"}],email:[{required:!0,message:o("user.emailRequired"),trigger:"blur"},{type:"email",message:o("user.emailInvalid"),trigger:"blur"}],phone:[{pattern:$,message:o("user.phoneInvalid"),trigger:"blur"}],bio:[{max:200,message:o("user.bioMax"),trigger:"blur"}]})),N=r=>{const a=r.name.split(".").pop()?.toLowerCase()||"",c=j.includes(a),I=r.size<T;return c?I?!0:(n.error(o("message.avatarSizeError")),!1):(n.error(o("message.avatarFormatError")),!1)},y=async r=>{const a=r.file;if(!N(a))return;i.value=a;const c=new FileReader;c.onload=I=>{e.headPic=I.target?.result},c.onerror=()=>{n.error(o("avatarPreviewFailed")),e.headPic=P},c.readAsDataURL(a)},A=r=>new Promise(a=>{const c=new Image;c.onload=()=>{console.log("头像测试加载成功:",r),a(!0)},c.onerror=()=>{console.log("头像测试加载失败:",r),a(!1)},c.src=r,setTimeout(()=>{console.log("头像测试加载超时:",r),a(!1)},J)}),h=(r,a=!1)=>{e.userName=r.userName||"",e.email=r.email||"",e.phone=r.phone||"",e.introduce=r.introduce||"",a&&r.headPic?e.headPic=`${S}${r.headPic}`:e.headPic=r.headPic||P},s=async()=>{try{if(console.log("开始加载用户资料，store.info:",t.info),t.info&&t.info.userId&&t.info.userId!==0)console.log("使用store中的用户信息:",t.info),h(t.info);else{console.log("store中用户信息不完整，从API获取...");const r=await F();if(console.log("API响应:",r),r.success&&r.data){const a=r.data;console.log("获取到的用户数据:",a),h(a,!0),t.setUserProfile({userName:a.userName,headPic:a.headPic?`${S}${a.headPic}`:P,email:a.email,phone:a.phone,introduce:a.introduce})}else console.error("API返回数据无效:",r),n.error("获取用户资料失败")}}catch(r){console.error("获取用户信息失败:",r),n.error(o("message.getUserInfoFailed"))}},f=async()=>{m.value&&await m.value.validate(async r=>{if(r){l.value=!0;try{const a=t.info,c=new FormData;i.value&&c.append("avatar",i.value);const I=[{field:"userName",formValue:e.userName||""},{field:"email",formValue:e.email||""},{field:"phone",formValue:e.phone||""},{field:"introduce",formValue:e.introduce||""}];let U=!!i.value;if(I.forEach(({field:d,formValue:u})=>{u!==a[d]&&(c.append(d,u),U=!0)}),!U){n.info(o("user.noChanges")),l.value=!1;return}const p=await v.put("/user/profile",c);if(p.code===200){const d={userName:e.userName,email:e.email,phone:e.phone,introduce:e.introduce};let u;p.data?.headPic?u=`${S}${p.data.headPic}`:i.value&&(u=e.headPic||void 0),u?.trim()?(console.log("检测到新头像，开始可用性验证:",u),setTimeout(async()=>{console.log("延迟验证新头像可用性..."),await A(u)?(console.log("新头像验证成功，更新store"),d.headPic=u,t.setUserProfile(d),n.success(o("user.profileUpdated"))):(console.log("新头像验证失败，使用默认头像"),d.headPic=t.info.headPic||P,t.setUserProfile(d),n.warning("头像更新可能存在延迟，如长时间未显示请刷新页面")),i.value=null},V)):(t.setUserProfile(d),n.success(o("user.profileUpdated")))}else n.error(p.message||o("user.updateFailed"))}catch(a){console.error("资料更新失败:",a),n.error(a.response?.data?.message||o("user.updateFailed"))}finally{l.value=!1}}})};function b(){h(t.info),n.success(o("user.formReset"))}return O(()=>{s()}),{t:o,profileFormRef:m,loading:l,profileForm:e,pendingAvatarFile:i,computedRules:g,beforeImageUpload:N,handleImageUpload:y,testImageLoad:A,loadUserProfile:s,submitForm:f,resetForm:b}},x=R("user",()=>{const o=localStorage.getItem("userInfo"),t=localStorage.getItem("userId"),m=localStorage.getItem("userName");let l;if(o)try{l=JSON.parse(o),!l.userId&&t&&(l.userId=parseInt(t))}catch(s){console.error("解析存储的用户信息失败:",s),localStorage.removeItem("userInfo"),l={userName:"",headPic:"/src/assets/img/dog.jpg",userId:t?parseInt(t):0,email:"",phone:"",introduce:""}}else l={userName:m||"",headPic:"/src/assets/img/dog.jpg",userId:t?parseInt(t):0,email:"",phone:"",introduce:""},(t||m)&&console.log("从独立字段恢复用户信息:",JSON.stringify(l,null,2));const e=E(l);let i=!1,g=null;return{info:e,fetchProfile:async()=>i&&g?(console.log("用户资料请求已在进行中，等待现有请求完成"),g):e.userId&&e.userId!==0&&e.userName&&e.userName!==""?(console.log("用户资料已存在且完整，跳过请求"),Promise.resolve()):(e.userId&&e.userId!==0&&(!e.userName||e.userName==="")&&console.log("用户ID存在但信息不完整，需要获取完整资料"),i=!0,g=(async()=>{try{const s=await F();s.success?(console.log("用户数据结构:",JSON.stringify(s.data,null,2)),typeof s.data=="object"&&s.data!==null?(e.userName="",e.headPic="/src/assets/img/dog.jpg",e.email="",e.phone="",e.introduce="",e.userName=s.data.userName||"",e.headPic=s.data.headPic?`/api/images/${s.data.headPic}`:"/src/assets/img/dog.jpg",e.email=s.data.email||"",e.phone=s.data.phone||"",e.introduce=s.data.introduce||"",s.data.userId?(e.userId=s.data.userId,console.log("从API获取到userId:",s.data.userId)):console.log("API返回的用户数据中没有userId字段")):(console.log("API返回的数据不是对象，可能是:",typeof s.data,s.data),typeof s.data=="number"&&(console.log("API返回的是数字，假设为userId:",s.data),e.userId=s.data)),localStorage.setItem("userInfo",JSON.stringify(e)),console.log("用户资料获取成功 - 用户名:",e.userName,"用户ID:",e.userId),console.log("完整的用户信息:",JSON.stringify(e,null,2))):s.message!=="用户未登录或缺少必要信息"&&n.error(s.message||"获取用户资料失败")}catch(s){console.error("获取用户资料失败:",s),n.error("获取用户资料失败")}finally{i=!1,g=null}})(),g),changePassword:async s=>{try{const f=await v.put("/user/updatePassword",{currentPassword:s.currentPassword,newPassword:s.newPassword});if(f.code===200)return{success:!0,message:"密码修改成功"};throw new Error(f?.message||"密码修改失败")}catch(f){throw console.error("修改密码失败:",f),f}},setUserProfile:s=>{s.userName&&(e.userName=s.userName,localStorage.setItem("userName",e.userName),console.log("用户名已更新:",e.userName)),s.headPic&&(e.headPic=s.headPic,localStorage.setItem("headPic",e.headPic),console.log("头像已更新:",e.headPic)),s.email!==void 0&&(e.email=s.email,localStorage.setItem("email",s.email),console.log("邮箱已更新:",s.email)),s.phone!==void 0&&(e.phone=s.phone,localStorage.setItem("phone",s.phone),console.log("电话已更新:",s.phone)),s.introduce!==void 0&&(e.introduce=s.introduce,localStorage.setItem("introduce",s.introduce),console.log("简介已更新:",s.introduce)),localStorage.setItem("userInfo",JSON.stringify(e)),console.log("完整的用户信息已同步到localStorage:",JSON.stringify(e,null,2))},setUsername:s=>{e.userName=s,localStorage.setItem("userName",s)}}});export{q as a,x as u};
