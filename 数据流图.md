# 宠物领养平台数据流图

## 系统架构概览

该宠物领养平台采用前后端分离架构：
- **前端**: Vue.js 3 + TypeScript + Element Plus
- **后端**: Spring Boot + MyBatis Plus + MySQL
- **通信**: RESTful API + WebSocket

## 数据流图

```mermaid
graph TB
    %% 前端部分
    subgraph "前端 (Vue.js)"
        A[用户界面] --> B[路由管理]
        B --> C[视图组件]
        C --> D[状态管理 Pinia]
        D --> E[API请求层]
        E --> F[HTTP客户端]
    end

    %% 后端部分
    subgraph "后端 (Spring Boot)"
        G[Web层 Controller] --> H[Service层]
        H --> I[Mapper层]
        I --> J[数据库 MySQL]
        H --> K[WebSocket服务]
    end

    %% 数据库部分
    subgraph "数据库 (MySQL)"
        J --> L[用户表 users]
        J --> M[宠物表 pets]
        J --> N[领养表 adoptions]
        J --> O[寄养表 fosters]
        J --> P[收容所表 shelters]
        J --> Q[宠物健康表 pet_health]
        J --> R[宠物记录表 pet_records]
        J --> S[媒体文件表 media_files]
        J --> T[文章表 articles]
        J --> U[登录历史表 login_history]
    end

    %% 连接关系
    F -- HTTP请求 --> G
    G -- 响应数据 --> F
    K -- WebSocket --> F

    %% 数据流向说明
    classDef frontend fill:#e1f5fe
    classDef backend fill:#f3e5f5
    classDef database fill:#e8f5e9
    classDef flow fill:#fff3e0

    class A,B,C,D,E,F frontend
    class G,H,I,K backend
    class J,L,M,N,O,P,Q,R,S,T,U database
```

## 核心业务数据流

### 1. 用户认证流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as 前端Vue
    participant C as Controller
    participant S as Service
    participant M as Mapper
    participant DB as 数据库

    U->>V: 输入用户名密码
    V->>C: POST /user/login
    C->>S: 调用登录验证
    S->>M: 查询用户信息
    M->>DB: SELECT FROM users
    DB-->>M: 返回用户数据
    M-->>S: 用户信息
    S->>S: 验证密码
    S->>S: 生成JWT Token
    S-->>C: 返回Token和用户信息
    C-->>V: 响应登录结果
    V->>V: 存储Token到localStorage
    V-->>U: 显示登录成功
```

### 2. 宠物领养流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as 前端Vue
    participant C as PetsController
    participant S as PetsService
    participant A as AdoptionsService
    participant M as Mapper
    participant DB as 数据库

    U->>V: 浏览可领养宠物
    V->>C: GET /pets/info/available
    C->>S: 查询可领养宠物
    S->>M: 查询宠物列表
    M->>DB: SELECT FROM pets WHERE status='UNADOPTED'
    DB-->>M: 宠物列表
    M-->>S: 宠物数据
    S-->>C: 宠物列表
    C-->>V: 响应宠物数据
    V-->>U: 显示宠物列表

    U->>V: 选择宠物并申请领养
    V->>C: POST /pets/adopt
    C->>A: 处理领养申请
    A->>M: 检查宠物状态
    M->>DB: SELECT FROM pets WHERE pid=?
    DB-->>M: 宠物状态
    M-->>A: 宠物信息
    A->>M: 更新宠物状态
    M->>DB: UPDATE pets SET status='ADOPTED'
    A->>M: 创建领养记录
    M->>DB: INSERT INTO adoptions
    DB-->>M: 领养记录ID
    M-->>A: 操作结果
    A-->>C: 领养结果
    C-->>V: 响应领养结果
    V-->>U: 显示领养成功
```

### 3. 宠物寄养流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as 前端Vue
    participant C as PetsController
    participant S as PetsService
    participant F as FosterService
    participant M as Mapper
    participant DB as 数据库

    U->>V: 申请寄养宠物
    V->>C: POST /pets/{petId}/foster
    C->>F: 处理寄养申请
    F->>M: 检查宠物状态
    M->>DB: SELECT FROM pets WHERE pid=?
    DB-->>M: 宠物状态
    M-->>F: 宠物信息
    F->>M: 更新宠物状态
    M->>DB: UPDATE pets SET status='FOSTERING'
    F->>M: 创建寄养记录
    M->>DB: INSERT INTO fosters
    DB-->>M: 寄养记录ID
    M-->>F: 操作结果
    F-->>C: 寄养结果
    C-->>V: 响应寄养结果
    V-->>U: 显示寄养成功
```

### 4. 宠物记录管理流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as 前端Vue
    participant C as PetRecordsController
    participant S as PetRecordsService
    participant M as Mapper
    participant DB as 数据库

    U->>V: 添加宠物记录
    V->>C: POST /events
    C->>S: 处理记录创建
    S->>M: 保存宠物记录
    M->>DB: INSERT INTO pet_records
    DB-->>M: 记录ID
    M-->>S: 操作结果
    
    alt 有媒体文件
        S->>M: 保存媒体文件信息
        M->>DB: INSERT INTO media_files
        DB-->>M: 文件记录ID
        M-->>S: 文件保存结果
    end
    
    S-->>C: 记录创建结果
    C-->>V: 响应创建结果
    V-->>U: 显示创建成功
```

### 5. 健康提醒流程

```mermaid
sequenceDiagram
    participant T as 定时任务
    participant S as HealthService
    participant M as Mapper
    participant DB as 数据库
    participant W as WebSocket
    participant V as 前端Vue

    T->>S: 触发健康提醒检查
    S->>M: 查询即将到期的健康提醒
    M->>DB: SELECT FROM pet_health WHERE reminder_time <= NOW()
    DB-->>M: 健康提醒列表
    M-->>S: 提醒数据
    S->>W: 推送提醒消息
    W->>V: WebSocket推送
    V-->>U: 显示健康提醒
```

## 数据模型关系图

```mermaid
erDiagram
    users ||--o{ adoptions : "1:N"
    users ||--o{ fosters : "1:N"
    users ||--o{ pet_records : "1:N"
    users ||--o{ media_files : "1:N"
    users ||--o{ login_history : "1:N"
    
    shelters ||--o{ pets : "1:N"
    shelters ||--o{ fosters : "1:N"
    
    pets ||--o{ adoptions : "1:1"
    pets ||--o{ fosters : "1:N"
    pets ||--o{ pet_health : "1:N"
    pets ||--o{ pet_records : "1:N"
    
    pet_records ||--o{ media_files : "1:N"
    
    users {
        int id PK
        string username
        string phone
        string password_hash
        string introduce
        string headpic
        string email
        datetime created_at
    }
    
    pets {
        int pid PK
        string name
        string species
        string breed
        int age
        string gender
        enum status
        int shelter_id FK
        string img_url
    }
    
    adoptions {
        int aid PK
        int pid FK
        int uid FK
        datetime adopt_date
    }
    
    fosters {
        int fid PK
        int pid FK
        int uid FK
        int sid FK
        datetime start_date
        datetime end_date
    }
    
    pet_health {
        int health_id PK
        int pid FK
        datetime check_date
        string health_type
        text description
        datetime reminder_time
        string status
    }
    
    pet_records {
        int record_id PK
        int pid FK
        int uid FK
        string event_type
        string mood
        text description
        string location
        datetime record_time
    }
    
    media_files {
        int mid PK
        int record_id FK
        int uid FK
        string file_name
        string file_path
        string media_type
        bigint file_size
    }
    
    shelters {
        int sid PK
        string name
        string location
        int capacity
    }
    
    articles {
        int id PK
        string title
        text content
        string summary
        string author
        string cover_image
        int view_count
        enum status
    }
    
    login_history {
        int id PK
        int user_id FK
        datetime login_time
        string ip_address
        string user_agent
        string device
        string location
        enum status
    }
```

## 技术架构数据流

```mermaid
graph TB
    subgraph "前端技术栈"
        A1[Vue.js 3] --> A2[TypeScript]
        A2 --> A3[Element Plus UI]
        A3 --> A4[Pinia状态管理]
        A4 --> A5[Vue Router]
        A5 --> A6[Axios HTTP客户端]
    end

    subgraph "后端技术栈"
        B1[Spring Boot] --> B2[Spring MVC]
        B2 --> B3[Spring Security]
        B3 --> B4[MyBatis Plus]
        B4 --> B5[MySQL数据库]
        B1 --> B6[WebSocket]
        B6 --> B7[定时任务]
    end

    subgraph "数据交互"
        C1[RESTful API] --> C2[JSON数据格式]
        C2 --> C3[JWT认证]
        C3 --> C4[文件上传]
        C4 --> C5[分页查询]
    end

    A6 -- HTTP请求 --> C1
    C1 -- API调用 --> B2
    B2 -- 业务处理 --> B4
    B4 -- SQL查询 --> B5
    B5 -- 数据返回 --> B4
    B4 -- 结果返回 --> B2
    B2 -- 响应数据 --> C1
    C1 -- JSON响应 --> A6

    B6 -- 实时推送 --> A6

    classDef frontend fill:#e1f5fe
    classDef backend fill:#f3e5f5
    classDef data fill:#e8f5e9

    class A1,A2,A3,A4,A5,A6 frontend
    class B1,B2,B3,B4,B5,B6,B7 backend
    class C1,C2,C3,C4,C5 data
```

## 关键数据流说明

1. **用户认证数据流**：
   - 用户登录信息通过前端发送到后端
   - 后端验证用户凭据并生成JWT Token
   - Token存储在前端localStorage中
   - 后续请求携带Token进行身份验证

2. **宠物管理数据流**：
   - 宠物信息存储在pets表中
   - 宠物状态包括：UNADOPTED（未领养）、ADOPTED（已领养）、FOSTERING（寄养中）等
   - 领养和寄养操作会更新宠物状态并创建相应记录

3. **文件上传数据流**：
   - 媒体文件通过multipart/form-data上传
   - 文件保存在服务器uploads/media目录
   - 文件信息记录在media_files表中

4. **实时通信数据流**：
   - 健康提醒通过WebSocket实时推送给前端
   - 前端接收推送并显示提醒通知

5. **分页查询数据流**：
   - 列表查询支持分页参数
   - 后端使用MyBatis Plus分页插件
   - 返回分页元数据（总记录数、当前页、总页数等）

这个数据流图展示了宠物领养平台中数据如何在各个组件之间流动，从用户界面到数据库，以及后端服务之间的交互关系。