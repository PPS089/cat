<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.petservice.mapper.ListPetsMapper">
    <select id="selectByPage" resultType="com.example.petpojo.entity.Pets">
        SELECT 
            p.pid,
            p.name,
            p.breed,
            p.age,
            p.gender,
            p.img_url,
            p.species,
            p.status,
            p.shelter_id,
            s.sid,
            s.name as shelterName,
            s.location as shelterAddress
        FROM pets p
        LEFT JOIN shelters s ON p.shelter_id = s.sid
        WHERE p.status = 'UNADOPTED'
        ORDER BY p.pid
    </select>
    
    <select id="selectPetById" resultType="com.example.petpojo.entity.Pets">
        SELECT 
            p.pid,
            p.name,
            p.breed,
            p.age,
            p.gender,
            p.img_url,
            p.species,
            p.status,
            p.shelter_id,
            s.sid,
            s.name as shelterName,
            s.location as shelterAddress
        FROM pets p
        LEFT JOIN shelters s ON p.shelter_id = s.sid
        WHERE p.pid = #{petId}
    </select>
    
    <!-- 根据条件查询宠物列表，支持品种、性别、年龄范围等筛选 -->
    <select id="selectPetListByPage" resultType="com.example.petpojo.vo.PetListVo">
        SELECT 
            p.pid,
            p.name,
            p.species,
            p.breed,
            p.age,
            p.gender,
            p.img_url as imgUrl,
            p.status,
            s.name as shelterName,
            s.location as shelterAddress
        FROM pets p
        LEFT JOIN shelters s ON p.shelter_id = s.sid
        WHERE 1=1
        
        <if test="queryDto.breed != null and queryDto.breed != ''">
    AND p.breed LIKE CONCAT('%', #{queryDto.breed}, '%')
</if>

<if test="queryDto.gender != null and queryDto.gender != ''">
    AND p.gender = 
    <choose>
        <when test="queryDto.gender == 'male'">'公'</when>
        <when test="queryDto.gender == 'female'">'母'</when>
        <otherwise>#{queryDto.gender}</otherwise>
    </choose>
</if>

<if test="queryDto.minAge != null">
    AND p.age >= #{queryDto.minAge}
</if>

<if test="queryDto.maxAge != null">
    <![CDATA[ AND p.age <= #{queryDto.maxAge} ]]>
</if>
        
        ORDER BY p.pid
    </select>
    
    <!-- 新增根据ID查询PetListVo的查询语句 -->
    <select id="selectPetListById" resultType="com.example.petpojo.vo.PetListVo">
        SELECT 
            p.pid,
            p.name,
            p.species,
            p.breed,
            p.age,
            p.gender,
            p.img_url as imgUrl,
            p.status,
            s.name as shelterName,
            s.location as shelterAddress
        FROM pets p
        LEFT JOIN shelters s ON p.shelter_id = s.sid
        WHERE p.pid = #{petId}
    </select>
    
    <!-- 查询宠物详情的SQL，返回PetsDetailsVo -->
    <select id="selectPetDetailsById" resultType="com.example.petpojo.vo.PetsDetailsVo">
        SELECT 
            p.pid,
            p.name,
            p.species,
            p.breed,
            p.age,
            p.gender,
            p.img_url as imgUrl,
            p.status,
            CONCAT(p.name, '是一只可爱的', IFNULL(p.breed, '宠物'), '，正在寻找温暖的家庭') as description,
            '健康' as healthStatus,
            true as vaccinated,
            false as neutered,
            200 as adoptionFee,
            50 as fosterFee,
            p.shelter_id as shelterId,
            s.name as shelterName,
            s.location as shelterAddress
        FROM pets p
        LEFT JOIN shelters s ON p.shelter_id = s.sid
        WHERE p.pid = #{petId}
    </select>
</mapper>