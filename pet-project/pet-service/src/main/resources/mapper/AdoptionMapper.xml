<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.petservice.mapper.AdoptionsMapper">
    <select id="getAdoptionsInfo" resultType="com.example.petpojo.vo.AdoptionsVo">
        SELECT
        a.aid AS aid,  -- 直接对应 VO 的 aid
        p.pid AS pid,  -- 对应 VO 的 pid（宠物ID）
        a.adopt_date AS adoptionDate,  -- 数据库 adopt_date → VO adoptionDate（驼峰对应）
        p.name AS name,  -- 宠物名 → VO name（无冲突，直接对应）
        p.species AS species,  -- 添加物种字段映射
        p.breed AS breed,  -- 宠物品种 → VO breed
        p.age AS age,  -- 宠物年龄 → VO age
        p.gender AS gender,  -- 宠物性别 → VO gender
        p.img_url AS image,  -- 数据库 img_url → VO image（名称不一致，用 AS 映射）
        s.sid AS sid,  -- 收容所ID → VO sid
        s.name AS sname,  -- 收容所名 → VO sname（解决与宠物名的冲突）
        s.location AS location,  -- 收容所地址 → VO location
        CASE 
            WHEN p.status = 'FOSTERING' THEN 1 
            ELSE 0 
        END AS isFostering,  -- 根据宠物状态判断是否寄养
        p.status AS petStatus  -- 宠物状态
        FROM adoptions a
        JOIN pets p ON a.pid = p.pid
        JOIN shelters s ON p.shelter_id = s.sid
        WHERE a.uid = #{uid}
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="getUserAdoptions" resultType="com.example.petpojo.vo.AdoptionsVo">
        SELECT
        a.aid AS aid,
        p.pid AS pid,
        a.adopt_date AS adoptionDate,
        p.name AS name,
        p.species AS species,  -- 添加物种字段映射
        p.breed AS breed,
        p.age AS age,
        p.gender AS gender,
        p.img_url AS image,
        s.sid AS sid,
        s.name AS sname,
        s.location AS location,
        CASE 
            WHEN p.status = 'FOSTERING' THEN 1 
            ELSE 0 
        END AS isFostering,  -- 根据宠物状态判断是否寄养
        p.status AS petStatus  -- 宠物状态
        FROM adoptions a
        JOIN pets p ON a.pid = p.pid
        JOIN shelters s ON p.shelter_id = s.sid
        WHERE a.uid = #{userId}
        ORDER BY a.adopt_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 简化版的领养记录查询，只关注领养本身 -->
    <select id="getUserAdoptionsSimple" resultType="com.example.petpojo.vo.AdoptionsVo">
        SELECT
        a.aid AS aid,
        p.pid AS pid,
        a.adopt_date AS adoptionDate,
        p.name AS name,
        p.species AS species,  -- 添加物种字段映射
        p.breed AS breed,
        p.age AS age,
        p.gender AS gender,
        p.img_url AS image,
        s.sid AS sid,
        s.name AS sname,
        s.location AS location,
        CASE 
            WHEN p.status = 'FOSTERING' THEN 1 
            ELSE 0 
        END AS isFostering,
        p.status AS petStatus  -- 宠物状态
        FROM adoptions a
        JOIN pets p ON a.pid = p.pid
        JOIN shelters s ON p.shelter_id = s.sid
        WHERE a.uid = #{userId}
        ORDER BY a.adopt_date DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- MyBatis Plus分页查询用户领养记录 -->
    <select id="selectUserAdoptionsWithPage" resultType="com.example.petpojo.vo.AdoptionsVo">
        SELECT
        a.aid AS aid,
        p.pid AS pid,
        a.adopt_date AS adoptionDate,
        p.name AS name,
        p.species AS species,  -- 添加物种字段映射
        p.breed AS breed,
        p.age AS age,
        p.gender AS gender,
        p.img_url AS image,
        s.sid AS sid,
        s.name AS sname,
        s.location AS location,
        CASE 
            WHEN p.status = 'FOSTERING' THEN 1 
            ELSE 0 
        END AS isFostering,
        p.status AS petStatus
        FROM adoptions a
        JOIN pets p ON a.pid = p.pid
        JOIN shelters s ON p.shelter_id = s.sid
        WHERE a.uid = #{userId}
        ORDER BY a.adopt_date DESC
    </select>
</mapper>